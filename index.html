<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>рд╕реИрдиреА рдЯреНрд░реЗрдбрд┐рдВрдЧ рдХрдВрдкрдиреА</title>

<!-- Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<!-- Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
/* GLOBAL */
body { background:#f8fafc; padding:20px; font-family:'Poppins',sans-serif; }
.card { border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.12); margin-bottom:20px; }
.header {
    background:#0d6efd;
    color:white;
    text-align:center;
    padding:12px;
    border-radius:15px 15px 0 0;
    font-weight:600;
    font-size:1.2rem;
    position: relative;   /* тнР рдпрд╣реА рдбрд╛рд▓рдирд╛ рд╣реИ */
}
.sub-header { background:#ffc107; padding:6px; text-align:center;
              font-weight:600; border-radius:0 0 15px 15px; }
.btn { border-radius:8px; font-weight:600; }
table { font-size:0.9rem; }

/* ЁЯМ╛ рдлрд╕рд▓ Display рдмреЙрдХреНрд╕ */
.fasal-note-box {
    background:#fff8d6; padding:12px; border-radius:10px;
    border-left:6px solid #f4c542; line-height:1.4;
    white-space:pre-line; font-size:14px;
}

/* ЁЯМ╛ Multi-Fasal Collapsible	UI */
.fasal-box {
    background:#fff8d6; border:2px solid #f4c542;
    padding:12px; border-radius:12px; margin-top:6px;
    white-space:pre-line;
}
.fasal-head {
    background:#ffe8a3; padding:6px 10px; border-radius:6px;
    cursor:pointer; font-weight:600;
}
.fasal-detail { display:none; }
/* === 3D METAL BLUE BACK BUTTON === */
.back-3d-btn {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);

    padding: 10px 22px;
    border-radius: 40px;

    background: linear-gradient(145deg, #6eb0ff, #2b7cff);
    border: 4px solid #dcdcdc;

    box-shadow:
        inset 0 4px 7px rgba(255,255,255,0.9),
        inset 0 -4px 7px rgba(0,0,0,0.25),
        0 6px 14px rgba(0,0,0,0.35),
        0 0 6px rgba(255,255,255,0.8);

    display: flex;
    align-items: center;
    justify-content: center;

    color: white;
    font-size: 22px;
    font-weight: 700;

    height: 45px;
    width: 85px;

    cursor: pointer;
    transition: 0.2s ease;
}

.back-3d-btn:active {
    transform: translateY(-50%) scale(0.96);
}
/* Customer table freeze columns */
th.check-col, td.check-col {
    position:sticky; left:0; background:white; z-index:30;
}
th.name-col, td.name-col {
    position:sticky; left:35px; background:white; z-index:29;
    white-space:normal; line-height:1.1;
    min-width:95px; max-width:95px;
}
th.reg-col, td.reg-col {
    width:55px !important; text-align:center; font-weight:bold;
}

/* Popup */
#popupOverlay, #fasalPopupOverlay, #villagePopup {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); display:none;
    justify-content:center; align-items:center; z-index:3000;
}
#popupBox {
    background:white; padding:20px; border-radius:12px;
    width:90%; max-width:420px;
}

/* тЬЕ PRINT FIX */
@media print {
#customerTableContainer {
    max-height: none !important;
    overflow: visible !important;
}
    /* Login screen hide */
    #loginScreen {
        display: none !important;
    }

    /* HeaderтАУbuttons hide */
    .btn, button, select, input {
        display: none !important;
    }

    /* Fasals ke upar wale рдмрдбрд╝реЗ рдмреЙрдХреНрд╕ hide */
    .summary-card,
    .total-fasal-wrapper,
    .fasal-summary-box,
    .fasal-box {
        display: none !important;
    }

    /* PDF рдореЗрдВ рд░рдВрдЧ рд╕рд╣реА рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП */
    body {
        -webkit-print-color-adjust: exact !important;
        background: white !important;
    }

    /* Table рдкреВрд░рд╛ рджрд┐рдЦреЗ */
    table, tr, td, th {
        color: #000 !important;
        background: white !important;
    }
}
td.name-col span {
    font-weight: 800 !important;
}
/* рдпрд╣рд╛рдБ рддреЗрд░реЗ рдмрд╛рдХреА CSS рд╣реИрдВ... */

/* рдпрд╣рд╛рдБ PRINT FIX рдбрд╛рд▓рдирд╛ рд╣реИ  =================== */
@media print {

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  html, body {
    height: auto !important;
    overflow: visible !important;
  }

  .card {
    page-break-inside: avoid !important;
  }

  table {
    page-break-inside: auto !important;
  }

  tr, td, th {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
  }

  #customerListCard {
    max-height: none !important;
    overflow: visible !important;
  }

}
/* ============================================= */

</style>
</head>


<body>

<!-- ЁЯФР LOGIN SCREEN -->
<div id="loginScreen" style="
    width:100%; max-width:400px; margin:40px auto;
    background:white; padding:25px; border-radius:15px;
    box-shadow:0 4px 10px rgba(0,0,0,0.25);">

  <h3 class="text-center mb-3">ЁЯФР рд▓реЙрдЧрд┐рди</h3>

  <input id="loginPass" type="password"
         class="form-control mb-3"
         placeholder="рдкрд╛рд╕рд╡рд░реНрдб рджрд░реНрдЬ рдХрд░реЗрдВ">

  <button class="btn btn-primary w-100 mb-2" onclick="loginNow()">рд▓реЙрдЧрд┐рди</button>
  <button class="btn btn-danger w-100 mb-2" onclick="showForgot()">тЭУ рдкрд╛рд╕рд╡рд░реНрдб рднреВрд▓ рдЧрдП?</button>

  <button class="btn btn-warning w-100 mb-2" onclick="registerFinger()">ЁЯФС рдлрд┐рдВрдЧрд░ рдкреНрд░рд┐рдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░</button>
  <button class="btn btn-success w-100" onclick="fingerLogin()">ЁЯФТ рдлрд┐рдВрдЧрд░ рд▓реЙрдЧрд┐рди</button>
</div>

<!-- ЁЯФС FORGOT PASSWORD BOX -->
<div id="forgotBox" style="
    display:none; width:100%; max-width:400px;
    margin:40px auto; background:white; padding:20px;
    border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.25);">

  <h4 class="text-center mb-3">ЁЯФС рдкрд╛рд╕рд╡рд░реНрдб рд░реАрд╕реЗрдЯ</h4>

  <input id="favName" class="form-control mb-2"
         placeholder="рдлреЗрд╡рд░реЗрдЯ рдирд╛рдо рд▓рд┐рдЦреЗрдВ">

  <button class="btn btn-success w-100" onclick="resetPass()">Reset рдХрд░реЗрдВ</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="hideForgot()">рд╡рд╛рдкрд╕</button>

</div>
<!-- тнР CUSTOMER LIST SCREEN -->
<div id="customerListCard" class="card" style="display:none">
  <div class="header">

    <button onclick="logoutNow()" class="btn btn-light btn-sm" style="float:left">
      ЁЯЪк Logout
    </button>

    рд╕реИрдиреА рдЯреНрд░реЗрдбрд┐рдВрдЧ рдХрдВрдкрдиреА

    <span id="mainDate" style="float:right; font-size:14px;"></span>
  </div>

  <div class="sub-header">рдЧреНрд░рд╛рд╣рдХ рд╕реВрдЪреА</div>

  <!-- рдХреБрд▓ рдЧреНрд░рд╛рд╣рдХ -->
  <div id="customerCount"
       class="text-center fw-bold my-2"
       style="color:red;">
    рдХреБрд▓ рдЧреНрд░рд╛рд╣рдХ: 0
  </div>

  <div class="card-body">

    <!-- рдХреБрд▓ рд╕рд╛рд░рд╛рдВрд╢ рдмрдЯрди -->
    <button class="btn btn-info w-100 mb-2" onclick="toggleSummary()">
      ЁЯФН рдХреБрд▓ рд╕рд╛рд░рд╛рдВрд╢
    </button>

    <!-- рд╕рд╛рд░рд╛рдВрд╢ рдмреЙрдХреНрд╕ -->
    <div id="totalSummary"
         class="alert alert-info text-center fw-bold mb-3"
         style="display:none">
      <!-- JS рд╕реЗ рднрд░реЗрдЧрд╛ -->
    </div>

    <!-- рдЧрд╛рдБрд╡ рдореИрдиреЗрдЬрд░ -->
    <button class="btn btn-dark w-100 mb-3" onclick="openVillageManager()">
      ЁЯПб рдЧрд╛рдБрд╡ рдкреНрд░рдмрдВрдзрди (Edit / Delete)
    </button>

    <!-- рд╕рд░реНрдЪ + рдЧрд╛рдБрд╡ рдлрд┐рд▓реНрдЯрд░ -->
    <div class="row mb-3">
      <div class="col-6">
        <input id="searchBox"
               class="form-control"
               placeholder="рдирд╛рдо рд╕реЗ рдЦреЛрдЬреЗрдВ...">
      </div>
      <div class="col-6">
        <select id="villageFilter" class="form-select">
          <option value="">рд╕рднреА рдЧрд╛рдБрд╡</option>
        </select>
      </div>
    </div>

    <!-- Delete buttons -->
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-danger flex-fill" onclick="deleteSelectedCustomers()">
        ЁЯЧС рдЪреБрдиреЗ рд╣реБрдП рд╣рдЯрд╛рдПрдВ
      </button>
      <button class="btn btn-danger flex-fill" onclick="deleteAllCustomers()">
        тЭМ рд╕рднреА рдЧреНрд░рд╛рд╣рдХ рд╣рдЯрд╛рдПрдВ
      </button>
    </div>

    <!-- рдирдпрд╛ рдЧреНрд░рд╛рд╣рдХ / рдкреНрд░рд┐рдВрдЯ / рдПрдХреНрд╕реЗрд▓ -->
    <button class="btn btn-success w-100 mb-3" onclick="openAddCustomer()">
      + рдирдпрд╛ рдЧреНрд░рд╛рд╣рдХ рдЬреЛрдбрд╝реЗрдВ
    </button>

    <button class="btn btn-secondary w-100 mb-3" onclick="printCustomers()">
      ЁЯЦи рдЧреНрд░рд╛рд╣рдХ рд╕реВрдЪреА рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ
    </button>

    <input type="file" id="excelUpload"
           accept=".xlsx,.xls,.csv"
           class="form-control mb-3"
           style="display:none">

    <button class="btn btn-warning w-100 mb-3"
            onclick="document.getElementById('excelUpload').click()">
      ЁЯУд Excel рд╕реЗ рдбреЗрдЯрд╛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ
    </button>

    <!-- рдЧреНрд░рд╛рд╣рдХ рдЯреЗрдмрд▓ -->
    <div id="customerTableContainer"
         class="table-responsive"
         style="max-height:65vh; overflow-y:auto;">

      <table class="table table-bordered text-center align-middle">
        <thead class="table-primary">
          <tr>
            <th class="check-col">
              <input type="checkbox" id="selectAll"
                     onchange="toggleSelectAll(this)">
            </th>
            <th class="name-col">рдирд╛рдо</th>
            <th class="reg-col">рд░.рди.</th>
            <th>рдкреБрддреНрд░</th>
            <th>рдЧрд╛рдБрд╡</th>
            <th>рдореЛрдмрд╛рдЗрд▓</th>
            <th>рдЖрдзрд╛рд░</th>
            <th>рдХрд╛рд░реНрдп</th>
          </tr>
        </thead>
        <tbody id="customerTable"></tbody>
      </table>

    </div>

  </div>
</div>

<!-- тнР ADD CUSTOMER SCREEN -->
<div id="addCustomerCard" class="card" style="display:none">
  <div class="header" id="formHeader">тЮХ рдирдпрд╛ рдЧреНрд░рд╛рд╣рдХ рдЬреЛрдбрд╝реЗрдВ</div>

  <div class="card-body">

    <input id="cName"   class="form-control mb-2" placeholder="рдирд╛рдо">
    <input id="cFather" class="form-control mb-2" placeholder="рдкреБрддреНрд░ рдХрд╛ рдирд╛рдо">

    <div class="input-group mb-2">
      <select id="cVillage" class="form-select">
        <option value="">рдЧрд╛рдБрд╡ рдЪреБрдиреЗрдВ</option>
      </select>
      <button class="btn btn-outline-secondary"
              type="button"
              onclick="addNewVillage()">+
      </button>
    </div>

    <input id="cPhone"  class="form-control mb-2" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░">
    <input id="cAadhar" class="form-control mb-3" placeholder="рдЖрдзрд╛рд░ рдирдВрдмрд░">
<input id="cRN" class="form-control mb-3" placeholder="рд░рдЬрд┐рд╕реНрдЯрд░ рдирдВрдмрд░ (R.N.)">
    <button class="btn btn-success w-100 mb-2" onclick="saveEditedCustomer()">
тЬФ рд╕рд╣реЗрдЬреЗрдВ
</button>

<button class="btn btn-secondary w-100" onclick="backToList()">
ЁЯФЩ рд╡рд╛рдкрд╕
</button>
  </div>
</div>

<!-- тнР Village Manager Popup -->
<div id="villagePopup">
  <div id="fasalPopupBox">

    <h4 class="text-center mb-3">ЁЯПб рдЧрд╛рдБрд╡ рдкреНрд░рдмрдВрдзрди</h4>

    <ul id="villageList" class="list-group mb-3"></ul>

    <button class="btn btn-success w-100 mb-2" onclick="addNewVillage()">
      + рдирдпрд╛ рдЧрд╛рдБрд╡ рдЬреЛрдбрд╝реЗрдВ
    </button>

    <button class="btn btn-secondary w-100" onclick="closeVillageManager()">
      рдмрдВрдж рдХрд░реЗрдВ
    </button>

  </div>
</div>
<!-- тнР FASAL MANAGER POPUP -->
<div id="fasalManagerPopup" style="display:none;
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:3000;">
  
  <div style="background:white;padding:20px;border-radius:12px;
      width:90%;max-width:400px;">

    <h4 class="text-center mb-3">ЁЯМ╛ рдлрд╕рд▓ рдкреНрд░рдмрдВрдзрди</h4>

    <input id="newFasalName" class="form-control mb-2" placeholder="рдирдИ рдлрд╕рд▓ рдХрд╛ рдирд╛рдо">

    <button class="btn btn-success w-100 mb-3" onclick="addNewFasal()">
      + рдЬреЛрдбрд╝реЗрдВ
    </button>

    <div id="fasalList" style="max-height:300px;overflow-y:auto;"></div>

    <button class="btn btn-danger w-100 mt-3" onclick="closeFasalManager()">
      тЭМ рдмрдВрдж рдХрд░реЗрдВ
    </button>
  </div>
</div>
<!-- тнР LEDGER SCREEN -->
<div id="ledgerCard" class="card" style="display:none">
 <div class="header">
    ЁЯУШ рдЧреНрд░рд╛рд╣рдХ рд▓реЗрдЬрд░

    <button class="btn btn-light float-end btn-sm" onclick="backToList()">ЁЯФЩ рд╡рд╛рдкрд╕</button>
        тЖР
    </button>
</div>

  <div class="sub-header" id="ledgerCustomerName"></div>

  <div class="card-body">

    <div class="d-flex gap-2 mb-3">

    <button class="btn btn-primary flex-fill" onclick="openTransactionPopup()">+ рд▓реЗрди-рджреЗрди</button>

    <button class="btn btn-success flex-fill" onclick="openFasalPopup()">ЁЯМ╛ рдлрд╕рд▓ рдЬреЛрдбрд╝реЗрдВ</button>

    <!-- тнР рдирдпрд╛ рдмрдЯрди рдпрд╣рд╛рдБ -->
    <button class="btn btn-warning flex-fill" onclick="openFasalManager()">ЁЯМ╛ рдлрд╕рд▓ рд▓рд┐рд╕реНрдЯ</button>

    <button class="btn btn-secondary flex-fill" onclick="printLedger()">ЁЯЦи рдкреНрд░рд┐рдВрдЯ</button>

</div>

    <!-- тнР Multi Fasal Summary Box (Collapsible) -->
    <div class="fasal-box">
        <div class="fasal-head" onclick="toggleFasalSummary()">ЁЯУК рдХреБрд▓ рдлрд╕рд▓ рд╕рд╛рд░рд╛рдВрд╢ (Tap)</div>
        <div id="fasalSummary" class="fasal-detail"></div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-bordered text-center">
        <thead class="table-warning">
  <tr>
    <th>рддрд╛рд░реАрдЦ</th>
    <th>рдЕрдВрддрд┐рдо рддрд╛рд░реАрдЦ</th>   <!-- тнР рдирдпрд╛ END DATE column -->
    <th>рдЬрдорд╛</th>
    <th>рдирд┐рдХрд╛рд╕реА</th>
    <th>рдмреНрдпрд╛рдЬ %</th>
    <th>рджрд┐рди</th>
    <th>рдмреНрдпрд╛рдЬ рд░рд╛рд╢рд┐</th>
    <th>рдлрд╕рд▓</th>
    <th>рдиреЛрдЯ</th>
    <th>рдХрд╛рд░реНрдп</th>
  </tr>
</thead>
        <tbody id="ledgerTable"></tbody>
        <tfoot id="ledgerFooter"></tfoot>
      </table>
    </div>

  </div>
</div>


<!-- тнР NORMAL TRANSACTION POPUP -->
<div id="transactionPopupOverlay"
     style="position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:none;
            justify-content:center; align-items:center; z-index:2000;">
  <div id="popupBox">

    <h5 class="text-center mb-3">ЁЯз╛ рдирдпрд╛ рд▓реЗрди-рджреЗрди</h5>
<input id="tDate" type="date" class="form-control mb-2" placeholder="рд╢реБрд░реВ рддрд╛рд░реАрдЦрд╝">
    <input id="tEndDate" type="date" class="form-control mb-2" placeholder="рдЕрдВрддрд┐рдо рддрд╛рд░реАрдЦрд╝">
    <input id="tCredit" type="number" class="form-control mb-2" placeholder="рдЬрдорд╛ (тВ╣)">
    <input id="tDebit" type="number" class="form-control mb-2" placeholder="рдирд┐рдХрд╛рд╕реА (тВ╣)">
    <input id="tInterest" type="number" class="form-control mb-2" placeholder="рдмреНрдпрд╛рдЬ (%)">
   <input id="tDays" type="number" class="form-control mb-2" placeholder="рджрд┐рди" readonly>

<input id="tInterestAmount" type="number" class="form-control mb-2" placeholder="рдмреНрдпрд╛рдЬ рд░рд╛рд╢рд┐ (тВ╣)" readonly>

<textarea id="tNote" class="form-control mb-3" placeholder="рдиреЛрдЯ"></textarea>

    <button class="btn btn-success w-100 mb-2" onclick="saveTransaction()">тЬФ рд╕рд╣реЗрдЬреЗрдВ</button>
    <button class="btn btn-danger w-100" onclick="closeTransactionPopup()">рд░рджреНрдж</button>
  </div>
</div>


<!-- тнР FASAL POPUP -->
<div id="fasalPopupOverlay"
     style="position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:none;
            justify-content:center; align-items:center; z-index:2000;">
  <div id="popupBox">

    <h5 class="text-center mb-3">ЁЯМ╛ рдирдИ рдлрд╕рд▓ рдЬреЛрдбрд╝реЗрдВ</h5>

    <select id="fName" class="form-select mb-2">
      <option value="">рдлрд╕рд▓ рдЪреБрдиреЗрдВ</option>
      <option>рд╕рд░рд╕реЛрдВ</option>
      <option>рдЧреЗрд╣реВрдВ</option>
      <option>рдмрд╛рдЬрд░рд╛</option>
      <option>рдзрд╛рди</option>
      <option>рдЪрдирд╛</option>
      <option>рдореВрдВрдЧрдлрд▓реА</option>
    </select>

    <div class="row">
      <div class="col-6">
        <input id="fBori" type="number" class="form-control mb-2" placeholder="рдмреЛрд░рд┐рдпрд╛рдБ">
      </div>
      <div class="col-6">
        <input id="fWeightPer" type="number" class="form-control mb-2" placeholder="1 рдмреЛрд░реА KG">
      </div>
    </div>

    <input id="fTotalQ" class="form-control mb-2" placeholder="рдХреБрд▓ рдХреНрд╡рд┐рдВрдЯрд▓" readonly>

    <input id="fRate" type="number" class="form-control mb-2" placeholder="рднрд╛рд╡ тВ╣/Q">
    <input id="fMajduri" type="number" class="form-control mb-2" placeholder="рдордЬрджреВрд░реА тВ╣/Q">

    <input id="fCutOther" type="number" class="form-control mb-2" placeholder="рдЕрдиреНрдп рдХрдЯреМрддреА (тВ╣)">
    <input id="fCutTotal" class="form-control mb-2" placeholder="рдХреБрд▓ рдХрдЯреМрддреА" readonly>

    <input id="fNetAmount" class="form-control fw-bold mb-2" placeholder="рд╢реБрджреНрдз рд░рд╛рд╢рд┐" readonly>

    <textarea id="fNote" class="form-control mb-3" placeholder="рдиреЛрдЯ"></textarea>

    <button class="btn btn-success w-100 mb-2" onclick="saveFasal()">тЬФ рд╕рд╣реЗрдЬреЗрдВ</button>
    <button class="btn btn-danger w-100" onclick="closeFasalPopup()">рд░рджреНрдж</button>

  </div>
</div>


<script>
window.onload = () => {
    if(localStorage.getItem("logged") === "yes"){
        loginScreen.style.display = "none";
        customerListCard.style.display = "block";
        loadCustomers();
    }
};

/* ======================================================
   Firebase Init
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyB30K96un0DsFbJ0-dx329za1HEnky3iC8",
  authDomain: "ms-saini.firebaseapp.com",
  databaseURL: "https://ms-saini-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ms-saini",
  storageBucket: "ms-saini.appspot.com",
  messagingSenderId: "56761297643",
  appId: "1:56761297643:web:efbb8d890036191cfcacae"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentCustomerId = null;

/* ======================================================
      CARD SWITCHING
====================================================== */
function showCard(id){
  customerListCard.style.display="none";
  addCustomerCard.style.display="none";
  ledgerCard.style.display="none";
  loginScreen.style.display="none";

  document.getElementById(id).style.display="block";
}

function backToList(){
  showCard("customerListCard");
  loadCustomers();
}

/* ======================================================
      LOAD CUSTOMERS
====================================================== */
function loadCustomers(){
  const ref = db.ref("customers");

  ref.once("value").then(snap=>{
      customerTable.innerHTML = "";

      snap.forEach(c=>{
        let d = c.val();
        let id = c.key;

        
        let row = `
        <tr>
          <td class="check-col"><input value="${id}" class="customerCheckbox" type="checkbox"></td>

          <td class="name-col">
            <span style="color:blue;cursor:pointer" onclick="openLedger('${id}')">
              ${(d.name || "").replace(/\s+\d+$/, "").replace(" ", "<br>")}
            </span>
          </td>

          <td class="reg-col">${d.rn || ((d.name || "").match(/\d+$/) || [""])[0]}</td>
      <td>${d.father || ""}</td>
          <td>${d.village || ""}</td>
          <td>${d.phone || ""}</td>
          <td>${d.aadhar || ""}</td>

          <td>
            <button class="btn btn-sm btn-primary" onclick="editCustomer('${id}')">тЬПя╕П</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${id}')">ЁЯЧС</button>
          </td>
        </tr>
        `;
        customerTable.insertAdjacentHTML("beforeend", row);
      });

      customerCount.innerText = "рдХреБрд▓ рдЧреНрд░рд╛рд╣рдХ: " + snap.numChildren();
  });
}

/* ======================================================
      OPEN LEDGER
====================================================== */
function openLedger(id){
  currentCustomerId = id;

  db.ref("customers/" + id).once("value").then(s=>{
    ledgerCustomerName.innerText = s.val().name;
  });

  showCard("ledgerCard");
  loadLedger();
}

/* ======================================================
      LOAD LEDGER + FASAL SUMMARY
====================================================== */
function loadLedger(){
  const ref = db.ref("ledgers/" + currentCustomerId);

  ref.once("value").then(snap=>{
      ledgerTable.innerHTML = "";

      let totalC = 0, totalD = 0, totalI = 0;
      let allFasal = [];

      snap.forEach(e=>{
        let d = e.val();
        let key = e.key;

        totalC += +d.credit || 0;
        totalD += +d.debit || 0;
        totalI += +d.interestAmount || 0;

        if(d.isFasal) allFasal.push(d);

        let row = `
<tr style="${d.isFasal ?
'background:#fff7d1;color:#b8860b;font-weight:bold;' : ''}">

    <td>${d.startDate || ""}</td>
    <td>${d.endDate || ""}</td>

    <td>тВ╣${d.credit || 0}</td>
    <td>тВ╣${d.debit || 0}</td>
    <td>${d.interest || 0}</td>
    <td>${d.days || 0}</td>
    <td>тВ╣${d.interestAmount || 0}</td>

    <td>${d.isFasal ? "ЁЯМ╛" : ""}</td>
    <td>${d.note || ""}</td>

    <td>
        ${
          d.isFasal
          ? `<button class="btn btn-sm btn-primary" onclick="editFasal('${key}')">тЬПя╕П</button>`
          : `<button class="btn btn-sm btn-primary" onclick="editTransaction('${key}')">тЬПя╕П</button>`
        }
        <button class="btn btn-sm btn-danger" onclick="deleteLedgerEntry('${key}')">тЭМ</button>
    </td>
</tr>
`; 
ledgerTable.insertAdjacentHTML("beforeend", row);
      });

      // тнР рдлрд╕рд▓ TOTAL рдЬреЛрдбрд╝реЗрдВ
let totalFasalNet = 0;
let totalFasalMajduri = 0;
let totalFasalCut = 0;

allFasal.forEach(f => {
    totalFasalNet += +f.netFasal || 0;
    totalFasalMajduri += +f.totalMajduri || 0;
    totalFasalCut += +f.totalCut || 0;
});

// тнР Final Balance Calculation (рдлрд╕рд▓ + рдордЬрджреВрд░реА + рдХрдЯреМрддреА рд╢рд╛рдорд┐рд▓)
let balance =
    (totalD + totalI) -
    (totalC + totalFasalNet + totalFasalMajduri + totalFasalCut);

// тнР FOOTER рджрд┐рдЦрд╛рдУ
ledgerFooter.innerHTML = `
<tr class="total-row" style="background:#fff3cd;font-weight:bold;color:#a66d00;">
    <td colspan="2">рдХреБрд▓</td>
    <td>тВ╣${totalC}</td>
    <td>тВ╣${totalD}</td>
    <td></td>
    <td>тВ╣${totalI.toFixed(2)}</td>
    <td colspan="3">
        рд╢реЗрд╖: тВ╣${balance.toFixed(2)}<br>
        <small>(рдиреЗрдЯ рдлрд╕рд▓: тВ╣${totalFasalNet} | рдордЬрджреВрд░реА: тВ╣${totalFasalMajduri} | рдХрдЯреМрддреА: тВ╣${totalFasalCut})</small>
    </td>
</tr>
`;
// =============== рдХреБрд▓ рдлрд╕рд▓ рдЯреЛрдЯрд▓ ===============
let fasalTQ = 0, fasalTAmount = 0, fasalTNet = 0;

allFasal.forEach(f => {
  fasalTQ += +f.quintal || 0;
  fasalTAmount += +f.totalAmount || 0;
  fasalTNet += +f.netFasal || 0;
});

ledgerFooter.insertAdjacentHTML("beforeend", `
  <tr style="background:#fff3cd;font-weight:bold;color:#a66d00;">
    <td colspan="2">рдХреБрд▓ рдлрд╕рд▓</td>
    <td colspan="2">рдХреБрд▓ рдХреНрд╡рд┐рдВрдЯрд▓: ${fasalTQ.toFixed(2)}</td>
    <td colspan="2">рдХреБрд▓ рдХреАрдордд: тВ╣${fasalTAmount}</td>
    <td colspan="3">рдиреЗрдЯ рдлрд╕рд▓: тВ╣${fasalTNet}</td>
  </tr>
`);

      generateFasalSummary(allFasal);
  });
}

/* ======================================================
      COLLAPSE FASAL SUMMARY
====================================================== */
function toggleFasalSummary(){
  const b = fasalSummary;
  b.style.display = b.style.display == "block" ? "none" : "block";
}

function generateFasalSummary(all){
    if(all.length == 0){
        fasalSummary.innerHTML = "<div class='p-2 text-center'>рдХреЛрдИ рдлрд╕рд▓ рдирд╣реАрдВ</div>";
        return;
    }

    fasalSummary.innerHTML = ""; // рдкрд╣рд▓реЗ рд╕рд╛рдл рдХрд░реЛ

    all.forEach((f, i) => {
        fasalSummary.insertAdjacentHTML("beforeend", `
            <div class="fasal-box" style="margin:8px 0;padding:8px;border-radius:8px;background:#fff5d6;border:1px solid #e6c77e">
                <div onclick="openFasal(${i})" style="font-weight:bold;font-size:16px;cursor:pointer;">
                    тЦ╢ рдлрд╕рд▓ ${i+1} (Tap to open)
                </div>

                <div id="fasalDetail${i}" style="display:none;margin-top:6px;line-height:22px;">
                    ЁЯМ╛ рдХреНрд╡рд┐рдВрдЯрд▓: <b>${f.quintal}</b><br>
                    ЁЯТ░ рдХреАрдордд: <b>тВ╣${f.totalAmount}</b><br>
                    ЁЯз│ рдордЬрджреВрд░реА: <b>тВ╣${f.totalMaiduri}</b><br>
                    тЬВ рдХрдЯреМрддреА: <b>тВ╣${f.totalCut}</b><br>
                    ЁЯЯб рдиреЗрдЯ рдлрд╕рд▓: <b>тВ╣${f.netFasal}</b>
                </div>
            </div>
        `);
    });
}

function openFasal(i){
    const a = document.getElementById("fasalDetail"+i);
    a.style.display = a.style.display === "block" ? "none" : "block";
}

  

/* ======================================================
      SAVE NORMAL TRANSACTION
====================================================== */
function openTransactionPopup(){

    // рд╕рднреА fields clear рдХрд░реЛ
    tDate.value = "";
    tEndDate.value = "";
    tCredit.value = "";
    tDebit.value = "";
    tInterest.value = "";
    tDays.value = "";
    tInterestAmount.value = "";
    tNote.value = "";

    transactionPopupOverlay.style.display = "flex";
}
function closeTransactionPopup(){
  transactionPopupOverlay.style.display="none";
}

function saveTransaction(){

    let start = tDate.value || "";     // Start date рдЦрд╛рд▓реА allowed
    let end = tEndDate.value || "";    // End date рдЦрд╛рд▓реА allowed

    let days = 0;
    let totalInterest = 0;

    // рдпрджрд┐ user рдиреЗ end date рджреА рд╣реИ рддрднреА рджрд┐рди/рдмреНрдпрд╛рдЬ рдирд┐рдХрд╛рд▓реЛ
    if(start && end){
        let d1 = new Date(start);
        let d2 = new Date(end);

        days = Math.floor((d2 - d1) / (1000*60*60*24));

        if(days < 0){
            alert("End Date, Start Date рдХреЗ рдмрд╛рдж рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП!");
            return;
        }

        let amount = +tDebit.value || +tCredit.value || 0;
        let rate = +tInterest.value || 0;

        let monthlyInterest = (amount * rate) / 100;
        let dailyInterest = monthlyInterest / 30;
        totalInterest = dailyInterest * days;
    }

    let data = {
        startDate: start,
        endDate: end,
        credit: +tCredit.value || 0,
        debit: +tDebit.value || 0,
        interest: +tInterest.value || 0,
        days: days,
        interestAmount: totalInterest.toFixed(2),
        note: tNote.value
    };

    // тнР EDIT MODE
    if(window.editingTransactionId){
        db.ref("ledgers/" + currentCustomerId + "/" + window.editingTransactionId).update(data);
        window.editingTransactionId = null;
    }
    // тнР NEW ENTRY
    else{
        db.ref("ledgers/" + currentCustomerId).push(data);
    }

    closeTransactionPopup();
    loadLedger();
}
/* ======================================================
      FASAL AUTO CALC
====================================================== */
["fBori","fWeightPer","fRate","fMajduri","fCutOther"].forEach(id=>{
  document.getElementById(id).addEventListener("input", calcFasal);
});

function calcFasal(){
  let b = +fBori.value||0;
  let w = +fWeightPer.value||0;
  let r = +fRate.value||0;
  let m = +fMajduri.value||0;
  let o = +fCutOther.value||0;

  let totalKG = b * w;
  let q = totalKG / 100;
  fTotalQ.value = q.toFixed(2);

  let totalAmount = q * r;
  let totalMajduri = q * m;
  let totalCut = totalMajduri + o;
  let net = totalAmount - totalCut;

  fCutTotal.value = totalCut;
  fNetAmount.value = net;
}
function openFasalPopup() {
    fasalPopupOverlay.style.display = "flex";

    // ЁЯФе рд╣рд░ рдмрд╛рд░ dropdown refresh
    loadFasalDropdown();

    // ЁЯФе рд╕рднреА fields рд╕рд╛рдл (new entry)
    fName.value = "";
    fBori.value = "";
    fWeightPer.value = "";
    fTotalQ.value = "";
    fRate.value = "";
    fMajduri.value = "";
    fCutOther.value = "";
    fCutTotal.value = "";
    fNetAmount.value = "";
    fNote.value = "";

    // ЁЯФе Editing mode рдмрдВрдж
    window.editingFasalId = null;
}
/* ======================================================
      SAVE FASAL ENTRY
====================================================== */
function saveFasal(){

  if(!fName.value) return alert("рдлрд╕рд▓ рдЪреБрдиреЗрдВ!");

  let b = +fBori.value||0;
  let w = +fWeightPer.value||0;
  let q = +fTotalQ.value||0;
  let r = +fRate.value||0;
  let m = +fMajduri.value||0;
  let o = +fCutOther.value||0;

  let totalAmount = q * r;
  let totalMajduri = q * m;
  let totalCut = totalMajduri + o;
  let net = totalAmount - totalCut;

  let data = {
    isFasal:true,
    name:fName.value,
    bori:b,
    weightPer:w,
    quintal:q,
    rate:r,
    totalAmount,
    totalMajduri,
    totalCut,
    netFasal:net,
    note:fNote.value
  };

  // ЁЯФе EDIT MODE
  if(window.editingFasalId){
      db.ref("ledgers/" + currentCustomerId + "/" + window.editingFasalId).update(data);
      window.editingFasalId = null;
  } 

  // ЁЯФе NEW ENTRY MODE
  else {
      db.ref("ledgers/" + currentCustomerId).push(data);
  }

  closeFasalPopup();
  loadLedger();
}

/* ======================================================
      DELETE LEDGER ENTRY
====================================================== */
function deleteLedgerEntry(id){
  if(!confirm("рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?")) return;
  db.ref("ledgers/" + currentCustomerId + "/" + id).remove();
  loadLedger();
}

/* ======================================================
      PRINT
====================================================== */
function printLedger(){
    // рдлрд╕рд▓ рд╕рд╛рд░рд╛рдВрд╢ рд╣рдореЗрд╢рд╛ рджрд┐рдЦрд╛рдУ рддрд╛рдХрд┐ PDF рдореЗрдВ рдЖрдП
    fasalSummary.style.display = "block";

    // PDF рд╕реЗрд╡ рдХрд░реЛ
    window.print();
}
/* ======================================================
      SEARCH + FILTER SYSTEM
====================================================== */
document.getElementById("searchBox").addEventListener("input", () => filterCustomers());
document.getElementById("villageFilter").addEventListener("change", () => filterCustomers());

function filterCustomers() {
    let search = searchBox.value.toLowerCase();
    let village = villageFilter.value;

    [...customerTable.rows].forEach(r => {
        let name = r.cells[1].innerText.toLowerCase();
        let vill = r.cells[4].innerText;

        let ok =
            (search === "" || name.includes(search)) &&
            (village === "" || village === vill);

        r.style.display = ok ? "" : "none";
    });
}

/* ======================================================
      ADD CUSTOMER
====================================================== */
function openAddCustomer() {
    showCard("addCustomerCard");
}

function saveCustomer() {

    if (!cName.value) return alert("рдирд╛рдо рд▓рд┐рдЦреЗрдВ!");

    let obj = {
    name: cName.value,
    father: cFather.value,
    village: cVillage.value,
    phone: cPhone.value,
    aadhar: cAadhar.value,
    rn: cRN.value          // тнР рдирдпрд╛ рдЬреЛрдбрд╝рд╛
};

    db.ref("customers").push(obj);

    cName.value = "";
    cFather.value = "";
    cVillage.value = "";
    cPhone.value = "";
    cAadhar.value = "";

    backToList();
}

/* ======================================================
      EDIT CUSTOMER
====================================================== */
let editingCustomerId = null;

function editCustomer(id) {
    editingCustomerId = id;

    db.ref("customers/" + id).once("value").then(s => {
        let d = s.val();

        cName.value = d.name;
        cFather.value = d.father;
        cVillage.value = d.village;
        cPhone.value = d.phone;
        cAadhar.value = d.aadhar;
cRN.value = d.rn || "";
        showCard("addCustomerCard");
    });
}

/* save edited customer */
function saveEditedCustomer() {
    if (!editingCustomerId) return saveCustomer();

    let obj = {
        name: cName.value,
        father: cFather.value,
        village: cVillage.value,
        phone: cPhone.value,
        aadhar: cAadhar.value,
        rn: cRN.value        // тнР рдпрд╣ рд▓рд╛рдЗрди рдЬрд╝рд░реВрд░ рдбрд╛рд▓рдиреА рд╣реИ
    };

    db.ref("customers/" + editingCustomerId).update(obj);

    editingCustomerId = null;
    backToList();
}

/* ======================================================
      DELETE CUSTOMER
====================================================== */
function deleteCustomer(id) {
    if (!confirm("рдХреНрдпрд╛ рдЧреНрд░рд╛рд╣рдХ рд╣рдЯрд╛рдирд╛ рд╣реИ?")) return;

    db.ref("customers/" + id).remove();
    db.ref("ledgers/" + id).remove();

    loadCustomers();
}

/* ======================================================
      SELECT ALL CHECKBOX
====================================================== */
function toggleSelectAll(source) {
    document.querySelectorAll(".customerCheckbox").forEach(c => (c.checked = source.checked));
}

/* ======================================================
      DELETE SELECTED CUSTOMERS
====================================================== */
function deleteSelectedCustomers() {
    let selected = [...document.querySelectorAll(".customerCheckbox:checked")].map(c => c.value);

    if (selected.length === 0) return alert("рдХрд┐рд╕реА рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдЪреБрдирд╛ рдирд╣реАрдВ!");

    if (!confirm("рдЪреБрдиреЗ рд╣реБрдП рдЧреНрд░рд╛рд╣рдХ рд╣рдЯрд╛рдКрдБ?")) return;

    selected.forEach(id => {
        db.ref("customers/" + id).remove();
        db.ref("ledgers/" + id).remove();
    });

    loadCustomers();
}

/* ======================================================
      DELETE ALL CUSTOMERS
====================================================== */
function deleteAllCustomers() {
    if (!confirm("тЭМ рд╕рднреА рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рд╣рдЯрд╛рдирд╛ рд╣реИ?")) return;

    db.ref("customers").remove();
    db.ref("ledgers").remove();

    loadCustomers();
}

/* ======================================================
      PRINT CUSTOMER LIST
====================================================== */
function printCustomers() {
    window.print();
}

/* ======================================================
      EXCEL UPLOAD
====================================================== */
excelUpload.addEventListener("change", handleExcelUpload);

function handleExcelUpload(e) {
    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function () {
        let data = new Uint8Array(reader.result);
        let workbook = XLSX.read(data, { type: "array" });

        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet);

        json.forEach(row => {
            let c = {
                name: row.name || "",
                father: row.father || "",
                village: row.village || "",
                phone: row.phone || "",
                aadhar: row.aadhar || ""
            };
            db.ref("customers").push(c);
        });

        alert("Excel Import Done тЬФ");
        loadCustomers();
    };
    reader.readAsArrayBuffer(file);
}

/* ======================================================
      SUMMARY ON LIST PAGE
====================================================== */
function toggleSummary() {
    let box = totalSummary;
    if (box.style.display == "block") {
        box.style.display = "none";
        return;
    }

    db.ref("ledgers").once("value").then(snap => {
        let sumC = 0,
            sumD = 0,
            sumI = 0;

        snap.forEach(c => {
            c.forEach(r => {
                let d = r.val();
                sumC += +d.credit || 0;
                sumD += +d.debit || 0;
                sumI += +d.interestAmount || 0;
            });
        });

        let bal = (sumD + sumI) - sumC;

        box.innerHTML = `
          рдЬрдорд╛: тВ╣${sumC}<br>
          рдирд┐рдХрд╛рд╕реА: тВ╣${sumD}<br>
          рдмреНрдпрд╛рдЬ: тВ╣${sumI.toFixed(2)}<br>
          рд╢реЗрд╖: тВ╣${bal.toFixed(2)}
        `;
        box.style.display = "block";
    });
}

/* ======================================================
      VILLAGE MANAGER (FINAL WORKING)
====================================================== */

// Popup рдЦреЛрд▓рдирд╛
function openVillageManager() {
    let html = `
      <div id="villagePopupBox" style="background:white;padding:20px;border-radius:12px;width:90%;max-width:400px;">
         <h5 class="text-center mb-3">ЁЯПб рдЧрд╛рдБрд╡ рдкреНрд░рдмрдВрдзрди</h5>

         <input id="newVillage" class="form-control mb-2" placeholder="рдирдпрд╛ рдЧрд╛рдБрд╡ рдЬреЛрдбрд╝реЗрдВ">

         <button class="btn btn-success w-100 mb-3" onclick="addVillage()">тЬФ рдЬреЛрдбрд╝реЗрдВ</button>

         <div id="villageList" style="max-height:300px;overflow-y:auto;"></div>

         <button onclick="closeVillagePopup()" class="btn btn-danger w-100 mt-3">тЭМ рдмрдВрдж</button>
      </div>
    `;

    villagePopup.innerHTML = html;
    villagePopup.style.display = "flex";

    loadVillageList();
}

// Popup рдмрдВрдж рдХрд░рдирд╛
function closeVillagePopup() {
    villagePopup.style.display = "none";
}

/* тнР рдирдпрд╛ рдЧрд╛рдБрд╡ add рдХрд░рдирд╛ */
function addVillage() {
    let v = document.getElementById("newVillage").value.trim();
    if (!v) return alert("рдЧрд╛рдБрд╡ рдХрд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ!");

    // тЬФ рд╕рд╣реА рдЬрдЧрд╣ рд╕реЗрд╡ рд╣реЛрдЧрд╛
    db.ref("settings/villages").push(v);

    document.getElementById("newVillage").value = "";
    loadVillageList();
    loadVillageDropdown();
loadFasalDropdown();
}

/* тнР Village list рд▓реЛрдб рдХрд░рдирд╛ (Popup рдореЗрдВ) */
function loadVillageList() {
    const box = document.getElementById("villageList");
    box.innerHTML = "";

    db.ref("settings/villages").once("value").then(snap => {
        snap.forEach(v => {
            let name = v.val();
            let id = v.key;

            box.insertAdjacentHTML("beforeend", `
                <div class="d-flex justify-content-between p-2 border mb-1">
                    ${name}
                    <button class="btn btn-sm btn-danger" onclick="deleteVillage('${id}')">тЭМ</button>
                </div>
            `);
        });
    });
}

/* тнР Village delete рдХрд░рдирд╛ */
function deleteVillage(id) {
    db.ref("settings/villages/" + id).remove();
    loadVillageList();
    loadVillageDropdown();
}

/* тнР Dropdown рдореЗрдВ village рд▓реЛрдб рдХрд░рдирд╛ */
function loadVillageDropdown() {

    cVillage.innerHTML = `<option value="">рдЧрд╛рдБрд╡ рдЪреБрдиреЗрдВ</option>`;
    villageFilter.innerHTML = `<option value="">рд╕рднреА рдЧрд╛рдБрд╡</option>`;

    db.ref("settings/villages").once("value").then(snap => {
        snap.forEach(v => {
            let name = v.val();

            cVillage.insertAdjacentHTML("beforeend", `<option>${name}</option>`);
            villageFilter.insertAdjacentHTML("beforeend", `<option>${name}</option>`);
        });
    });
}

loadVillageDropdown();
/* ======================================================
      LOGIN SYSTEM
====================================================== */

const MASTER_PASS = "1234";          // рдЕрдкрдирд╛ рдкрд╛рд╕рд╡рд░реНрдб рдпрд╣рд╛рдБ рд╕реЗрдЯ рдХрд░реЛ
const FAV_NAME = "saini";            // Forgot password рд╡рд╛рд▓рд╛ рдирд╛рдо

function loginNow(){
    let p = loginPass.value.trim();
    if(p === MASTER_PASS){
localStorage.setItem("logged", "yes");
        loginScreen.style.display = "none";
        customerListCard.style.display = "block";
        loadCustomers();
    } else {
        alert("тЭМ рдЧрд▓рдд рдкрд╛рд╕рд╡рд░реНрдб!");
    }
}

function showForgot(){
    loginScreen.style.display = "none";
    forgotBox.style.display = "block";
}

function hideForgot(){
    forgotBox.style.display = "none";
    loginScreen.style.display = "block";
}

function resetPass(){
    let name = favName.value.trim().toLowerCase();
    if(name === FAV_NAME){
        alert("тЬФ рдЖрдкрдХрд╛ рдирдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИ: " + MASTER_PASS);
        hideForgot();
    } else {
        alert("тЭМ рдЧрд▓рдд рдирд╛рдо!");
    }
}

function logoutNow(){
localStorage.removeItem("logged");
    customerListCard.style.display = "none";
    ledgerCard.style.display = "none";
    addCustomerCard.style.display = "none";
    loginScreen.style.display = "block";
}

/* Dummy Fingerprint тАФ Mobile рдкрд░ рдХрд╛рдо рддрднреА рдХрд░реЗрдЧрд╛ рдЬрдм browser allow рдХрд░реЗ */
function registerFinger(){
    alert("Fingerprint Registered тЬФ");
}

function fingerLogin(){
    alert("Fingerprint Success тЬФ");
    loginNow();
}
function editFasal(id){
    db.ref("ledgers/" + currentCustomerId + "/" + id).once("value").then(s=>{
        let f = s.val();

        if(!f.isFasal){
            alert("рдпрд╣ рдлрд╕рд▓ рдПрдВрдЯреНрд░реА рдирд╣реАрдВ рд╣реИ!");
            return;
        }

        fasalPopupOverlay.style.display = "flex";

        fName.value = f.name;
        fBori.value = f.bori;
        fWeightPer.value = f.weightPer;
        fTotalQ.value = f.quintal;
        fRate.value = f.rate;

        let perMajduri = f.totalMajduri / f.quintal;
        fMajduri.value = perMajduri;

        fCutOther.value = f.totalCut - f.totalMajduri;

        fCutTotal.value = f.totalCut;
        fNetAmount.value = f.netFasal;
        fNote.value = f.note;

        window.editingFasalId = id;
    });
}
tDate.onchange = calcDays;
tEndDate.onchange = calcDays;
tInterest.oninput = calcInterest;
tDebit.oninput = calcInterest;
tDays.oninput = calcInterest;
function calcDays() {
    let start = tDate.value;
    let end = tEndDate.value;

    if (!start || !end) {
        tDays.value = "";
        tInterestAmount.value = "";
        return;
    }

    let d1 = new Date(start);
    let d2 = new Date(end);

    let diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));

    if (diff < 0) {
        alert("End Date, Start Date рдХреЗ рдмрд╛рдж рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП!");
        tEndDate.value = "";
        tDays.value = "";
        return;
    }

    tDays.value = diff;
    calcInterest();  // рджрд┐рди рдмрджрд▓рддреЗ рд╣реА рдмреНрдпрд╛рдЬ рднреА рдЕрдкрдбреЗрдЯ
}

function calcInterest() {
    let amount = (+tDebit.value || 0) + (+tCredit.value || 0);    // рд╕рд┐рд░реНрдл рдирд┐рдХрд╛рд╕реА рд░рд╛рд╢рд┐
    let rate = +tInterest.value || 0;    // рдмреНрдпрд╛рдЬ %
    let days = +tDays.value || 0;        // рджрд┐рди

    if(amount === 0 || rate === 0 || days === 0){
        tInterestAmount.value = "";
        return;
    }

    // Monthly interest = (amount * rate) / 100
    let monthlyInterest = (amount * rate) / 100;

    // Daily interest = monthlyInterest / 30
    let dailyInterest = monthlyInterest / 30;

    // Total interest = dailyInterest * days
    let totalInterest = dailyInterest * days;

    tInterestAmount.value = totalInterest.toFixed(2);
}
function editTransaction(id){
    window.editingTransactionId = id;

    db.ref("ledgers/" + currentCustomerId + "/" + id).once("value").then(s=>{
        let d = s.val();

        // Normal transaction рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, fasal рдирд╣реАрдВ
        if(d.isFasal){
            alert("рдпрд╣ рдлрд╕рд▓ рд╣реИ, рдЗрд╕реЗ рдлрд╕рд▓ Edit рдореЗрдВ рдЦреЛрд▓реЗрдВ!");
            return;
        }

        // Popup рдЦреЛрд▓реЛ
        transactionPopupOverlay.style.display = "flex";

        // рдкреБрд░рд╛рдиреЗ values рднрд░ рджреЛ
        tDate.value = d.startDate || "";
        tEndDate.value = d.endDate || "";
        tCredit.value = d.credit || 0;
        tDebit.value = d.debit || 0;
        tInterest.value = d.interest || 0;
        tDays.value = d.days || 0;
        tInterestAmount.value = d.interestAmount || 0;
        tNote.value = d.note || "";
    });
}
/* ======================================================
      FASAL MANAGER (ADD / DELETE)
====================================================== */

function openFasalManager() {
    document.getElementById("fasalManagerPopup").style.display = "flex";
    loadFasalList();
}

function closeFasalManager() {
    document.getElementById("fasalManagerPopup").style.display = "none";
}

function addNewFasal() {
    let name = document.getElementById("newFasalName").value.trim();

    if (!name) return alert("рдлрд╕рд▓ рдХрд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ!");

    db.ref("fasals").push({ name });
    document.getElementById("newFasalName").value = "";
    loadFasalList();
    loadFasalDropdown();   // dropdown refresh
}

function deleteFasal(id) {
    if (!confirm("рдХреНрдпрд╛ рдЖрдк рдлрд╕рд▓ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?")) return;

    db.ref("fasals/" + id).remove();
    loadFasalList();
    loadFasalDropdown();
}

function loadFasalList() {
    const box = document.getElementById("fasalList");
    box.innerHTML = "";

    db.ref("fasals").once("value").then(snap => {
        snap.forEach(f => {
            let d = f.val();
            let id = f.key;

            box.insertAdjacentHTML("beforeend", `
                <div class="d-flex justify-content-between p-2 border mb-1">
                    ${d.name}
                    <button class="btn btn-sm btn-danger" onclick="deleteFasal('${id}')">тЭМ</button>
                </div>
            `);
        });
    });
}

function loadFasalDropdown() {
    db.ref("fasals").once("value").then(snap => {
        fName.innerHTML = `<option value="">рдлрд╕рд▓ рдЪреБрдиреЗрдВ</option>`;

        snap.forEach(f => {
            let d = f.val();
            fName.insertAdjacentHTML("beforeend", `<option>${d.name}</option>`);
        });
    });
}
loadFasalDropdown();
function closeFasalPopup() {
    document.getElementById("fasalPopupOverlay").style.display = "none";
    window.editingFasalId = null;   // edit рдореЛрдб рдмрдВрдж
}
</script>
</body>
</html>

