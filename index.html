<!DOCTYPE html>
<html lang="hi">
<head>
<link rel="manifest" href="manifest.json"> 
<meta name="theme-color" content="#0d6efd">

<!-- SERVICE WORKER REGISTER -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<meta charset="UTF-8">
<title>‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
body { background:#f8fafc; padding:20px; font-family:'Poppins',sans-serif; }
.card { border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px; }
.header { background:#0d6efd; color:white; text-align:center; padding:12px; border-radius:15px 15px 0 0; font-weight:600; font-size:1.2rem; }
.sub-header { background:#ffc107; text-align:center; padding:6px; font-weight:600; border-radius:0 0 15px 15px; }
table { font-size:0.9rem; }
.btn { border-radius:8px; font-weight:600; }
#customerTableContainer {
  max-height: 65vh;
  overflow-y: auto;
}
#ledgerCard, #addCustomerCard, #popupOverlay { display:none; }

#popupOverlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000;
}
#popupBox { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:420px; }

.total-row { background:#e9f7ef; font-weight:bold; }

@media print {
  body { background:white; }
  button, .btn, select, input { display:none !important; }
  #popupOverlay { display:none !important; }
}
/* üëâ Mobile ‡§™‡§∞ Register No ‡§ï‡•â‡§≤‡§Æ ‡§õ‡•ã‡§ü‡§æ */
@media (max-width: 600px) {
  th.reg-col, td.reg-col {
      width: 45px !important;
      max-width: 45px !important;
      padding: 2px !important;
      font-size: 12px !important;
      text-align: center !important;
      white-space: nowrap;
  }
}
/* ‚≠ê Freeze Column 1 (Checkbox) */
th.check-col, td.check-col {
    position: sticky;
    left: 0;
    background: white;
    z-index: 30;
    width: 35px !important;
    min-width: 35px !important;
    max-width: 35px !important;
}

/* ‚≠ê Freeze Column 2 (Name) */
/* ‚≠ê Name Column ‚Äì 2 ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á */
th.name-col, td.name-col {
    position: sticky;
    left: 35px;
    background: white;
    z-index: 29;
    min-width: 95px !important;
    max-width: 95px !important;
    white-space: normal !important;   /* ‚≠ê allow line break */
    line-height: 1.1;
    text-align: center;
    font-size: 13px;
}

/* ‚≠ê Register Number */
th.reg-col, td.reg-col {
    width: 55px !important;
    min-width: 55px !important;
    max-width: 55px !important;
    font-size: 16px !important;
    font-weight: bold !important;
    text-align: center !important;
    white-space: nowrap;
}
</style>
</head>

<body>
<!-- üîê LOGIN SYSTEM START -->

<!-- LOGIN BOX -->
<div id="loginScreen" style="
    width:100%; max-width:400px; margin:40px auto;
    background:white; padding:25px; border-radius:15px;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
">
  <h3 class="text-center mb-3">üîê ‡§≤‡•â‡§ó‡§ø‡§®</h3>

  <input id="loginPass" type="password" class="form-control mb-3" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">

  <button class="btn btn-primary w-100 mb-2" onclick="loginNow()">‡§≤‡•â‡§ó‡§ø‡§®</button>

<button class="btn btn-danger w-100" onclick="showForgot()">‚ùì ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?</button>

<button class="btn btn-warning w-100 mb-2" onclick="registerFinger()">üîë Register Fingerprint</button>

<button class="btn btn-success w-100 mb-2" onclick="fingerLogin()">üîí Fingerprint Login</button>
</div>

<!-- FORGOT BOX -->
<div id="forgotBox" style="
    display:none; width:100%; max-width:400px; margin:40px auto;
    background:white; padding:20px; border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
">
  <h4 class="text-center mb-3">üîë ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü</h4>

  <input id="favName" class="form-control mb-2" placeholder="‡§´‡•á‡§µ‡§∞‡•á‡§ü ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç">

  <button class="btn btn-success w-100" onclick="resetPass()">Reset ‡§ï‡§∞‡•á‡§Ç</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="hideForgot()">‡§µ‡§æ‡§™‡§∏</button>
</div>

<script>

function bufferToBase64(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)));
}

async function registerFinger() {

    if (!window.PublicKeyCredential) {
        alert("‚ùå ‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç Fingerprint ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
        return;
    }

    const challenge = new Uint8Array(32);
    crypto.getRandomValues(challenge);

    try {
        const credential = await navigator.credentials.create({
            publicKey: {
                challenge,
                rp: { name: "Saini Trading Company" },
                user: {
                    id: new Uint8Array(16),
                    name: "user@saini",
                    displayName: "User"
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                authenticatorSelection: {
                    authenticatorAttachment: "platform",
                    userVerification: "required"
                },
                timeout: 60000
            }
        });

        const idBase64 = bufferToBase64(credential.rawId);

        localStorage.setItem("passkeyId", idBase64);

        alert("‚úÖ Fingerprint Register ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
    }
    catch (err) {
        console.error(err);
        alert("‚ùå Fingerprint Register Fail");
    }
}

async function fingerLogin() {

    if (!window.PublicKeyCredential) {
        alert("‚ùå ‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç Fingerprint ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
        return;
    }

    const keyIdBase64 = localStorage.getItem("passkeyId");

    if (!keyIdBase64) {
        alert("‚ö†Ô∏è ‡§™‡§π‡§≤‡•á Register Fingerprint ‡§¶‡§¨‡§æ‡§è‡§Å");
        return;
    }

    const keyId = Uint8Array.from(atob(keyIdBase64), c => c.charCodeAt(0));

    const challenge = new Uint8Array(32);
    crypto.getRandomValues(challenge);

    try {
        await navigator.credentials.get({
            publicKey: {
                challenge,
                timeout: 60000,
                userVerification: "required",
                allowCredentials: [{
                    id: keyId,
                    type: "public-key"
                }]
            }
        });

        alert("üîì Fingerprint Login Success!");

        localStorage.setItem("auth", "yes");

        loginScreen.style.display = "none";
        customerListCard.style.display = "block";

    } catch (error) {
        console.error(error);
        alert("‚ùå Fingerprint Login Fail");
    }
}

</script>
<script>
/* =============================
      LOGIN + LOGOUT SYSTEM
============================= */
// MAIN PASSWORD
let PASSWORD = "Saini@123";

// MASTER KEY (Emergency Login)
const MASTER_KEY = "786786";

// FORGOT SCREEN SECURITY ANSWER
const SECURITY_NAME = "SAINIRESET";
// LOAD SAVED PASSWORD FROM LOCAL STORAGE (STEP 1)
let savedPass = localStorage.getItem("PASSWORD");
if (savedPass) {
    PASSWORD = savedPass;
}

// AUTO LOGIN CHECK
document.addEventListener("DOMContentLoaded", function () {
    if (localStorage.getItem("auth") === "yes") {
        loginScreen.style.display = "none";
        customerListCard.style.display = "block";
    }
});

// LOGIN FUNCTION
function loginNow(){
  let p = loginPass.value.trim();

  if(p === PASSWORD || p === MASTER_KEY){
    localStorage.setItem("auth","yes");
    loginScreen.style.display = "none";
    customerListCard.style.display = "block";
  } else {
    alert("‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°");
  }
}

// FORGOT PASSWORD
function showForgot(){ loginScreen.style.display = "none"; forgotBox.style.display = "block"; }
function hideForgot(){ forgotBox.style.display = "none"; loginScreen.style.display = "block"; }

function resetPass(){
  let v = favName.value.trim().toUpperCase();

  if(v === SECURITY_NAME){
    let np = prompt("‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≤‡§ø‡§ñ‡•á‡§Ç:");

    if(np){

      // ‚≠ê ‡§®‡§à ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§≤‡§æ‡§á‡§®
      localStorage.setItem("PASSWORD", np);

      PASSWORD = np;
      alert("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° Reset ‡§π‡•ã ‡§ó‡§Ø‡§æ ‚úÖ");
      hideForgot();
    }

  } else {
    alert("‚ùå ‡§ó‡§≤‡§§ ‡§â‡§§‡•ç‡§§‡§∞");
  }
}

/* =============================
      üî• FIXED LOGOUT FUNCTION
============================= */
function logoutNow(){

  // 1) Login remove
  localStorage.removeItem("auth");
  sessionStorage.clear();

  // 2) Clear cache
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => caches.delete(name));
    });
  }

  // 3) Remove service workers
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(regs => {
      regs.forEach(reg => reg.unregister());
    });
  }

  // 4) Force fresh reload
  setTimeout(() => {
    location.href = "index.html";
  }, 300);
}
</script>

<!-- üîê LOGIN SYSTEM END -->
<!-- ‚úÖ CUSTOMER LIST CARD -->
<div id="customerListCard" class="card" style="display:none">
<div class="header">

    <button onclick="logoutNow()" 
            class="btn btn-light btn-sm"
            style="float:left; margin-right:10px;">
        üö™ Logout
    </button>

    ‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä

    <span id="mainDate" 
          style="float:right; font-size:14px;">
    </span>

</div>

<div class="sub-header">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä</div>
<!-- ‚≠ê TOTAL CUSTOMER COUNT (RED) ‚≠ê -->
<div id="customerCount" class="text-center fw-bold mb-2" style="font-size:16px; color:red;">
  ‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: 0
</div>

<div class="card-body">

  <button class="btn btn-info w-100 mb-2" onclick="toggleSummary()">
  üîç ‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡•á‡§ñ‡•á‡§Ç
  </button>

  <!-- SUMMARY BOX -->
  <div id="totalSummary" class="alert alert-info text-center fw-bold mb-3" 
       style="display:none; font-size:16px;">
    ‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ: ‚Çπ0 | ‡§ï‡•Å‡§≤ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä: ‚Çπ0 | ‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú: ‚Çπ0 | ‡§ï‡•Å‡§≤ ‡§∂‡•á‡§∑: ‚Çπ0
  </div>
<button class="btn btn-dark w-100 mb-3" onclick="openVillageManager()">
üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (Edit / Delete)
</button>
  <div class="row mb-3">

    <div class="col-6">
        <input type="text" id="searchBox" class="form-control" placeholder="‡§®‡§æ‡§Æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
    </div>

    <div class="col-6">
        <select id="villageFilter" class="form-select">
            <option value="">‡§∏‡§≠‡•Ä ‡§ó‡§æ‡§Å‡§µ</option>
        </select>
    </div>

</div>   <!-- ‚≠ê ‡§Ø‡§π ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡§æ ‡§≠‡•Ç‡§≤ ‡§ó‡§è ‡§•‡•á ‚≠ê -->

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-danger flex-fill" onclick="deleteSelectedCustomers()">üóëÔ∏è ‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§π‡§ü‡§æ‡§è‡§Ç</button>
    <button class="btn btn-danger flex-fill" onclick="deleteAllCustomers()">‚ùå ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§è‡§Ç</button>
</div>

  <button class="btn btn-success w-100 mb-3" onclick="openAddCustomer()">+ ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
  <button class="btn btn-secondary w-100 mb-3" onclick="printCustomers()">üñ®Ô∏è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>

  <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="form-control mb-3" style="display:none">
  <button class="btn btn-warning w-100 mb-3" onclick="document.getElementById('excelUpload').click()">üì§ Excel ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>

  <div id="customerTableContainer" class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-primary">
<tr>

  <th class="check-col">
    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
  </th>

  <th class="name-col">‡§®‡§æ‡§Æ</th>

  <th class="reg-col">‡§∞‡•ç ‡§®.</th>

  <th>‡§™‡•Å‡§§‡•ç‡§∞</th>
  <th>‡§ó‡§æ‡§Å‡§µ</th>
  <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
  <th>‡§Ü‡§ß‡§æ‡§∞</th>
  <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>

</tr>
</thead>
      <tbody id="customerTable"></tbody>
    </table>
  </div>

</div>
</div>

<!-- ‚≠ê Village Manager Popup -->
<div id="villagePopup" style="display:none; position:fixed; top:0; left:0;
width:100%; height:100%; background:rgba(0,0,0,0.5);
justify-content:center; align-items:center; z-index:2000;">

  <div style="background:white; padding:20px; width:90%;
  max-width:400px; border-radius:10px;">

    <h4 class="text-center mb-3">üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h4>

    <ul id="villageList" class="list-group mb-3"></ul>

    <button class="btn btn-success w-100 mb-2" onclick="addNewVillage()">+ ‡§®‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>

    <button class="btn btn-secondary w-100" onclick="closeVillageManager()">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>

  </div>

</div>
<!-- ‚≠ê Village Popup End -->


<!-- ‚úÖ ADD CUSTOMER CARD -->
<div id="addCustomerCard" class="card" style="display:none">
  <div class="header" id="formHeader">‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>
  <div class="card-body">

    <input id="cName" class="form-control mb-2" placeholder="‡§®‡§æ‡§Æ">
    <input id="cFather" class="form-control mb-2" placeholder="‡§™‡•Å‡§§‡•ç‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ">

    <div class="input-group mb-2">
      <select id="cVillage" class="form-select">
  <option value="">‡§ó‡§æ‡§Å‡§µ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
</select>
      <button class="btn btn-outline-secondary" onclick="addNewVillage()">+</button>
    </div>

    <input id="cPhone" type="tel" class="form-control mb-2" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞">
    <input id="cAadhar" type="text" class="form-control mb-3" placeholder="‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞">

    <button class="btn btn-success w-100 mb-2" onclick="saveCustomer()">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
    <button class="btn btn-secondary w-100" onclick="backToList()">‡§µ‡§æ‡§™‡§∏</button>

  </div>
</div>

<!-- ‚úÖ LEDGER CARD -->
<div id="ledgerCard" class="card" style="display:none">
<div class="header">
    ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§≤‡•á‡§ú‡§∞
    <span id="topDate" style="float:right; font-size:14px;"></span>
    <button class="btn btn-light btn-sm float-end" onclick="backToList()">‡§µ‡§æ‡§™‡§∏</button>
</div>

<div class="sub-header" id="ledgerCustomerName"></div>

<div class="card-body">

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-primary flex-fill" onclick="openPopup()">+ ‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    <button class="btn btn-secondary flex-fill" onclick="printLedger()">üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center">
      <thead class="table-warning">
        <tr>
          <th>‡§∂‡•Å‡§∞‡•Ç</th>
          <th>‡§Ö‡§Ç‡§§</th>
          <th>‡§ú‡§Æ‡§æ</th>
          <th>‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä</th>
          <th>‡§¨‡•ç‡§Ø‡§æ‡§ú (%)</th>
          <th>‡§¶‡§ø‡§®</th>
          <th>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§æ‡§∂‡§ø</th>
          <th>‡§®‡•ã‡§ü</th>
          <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
        </tr>
      </thead>
      <tbody id="ledgerTable"></tbody>
      <tfoot id="ledgerFooter"></tfoot>
    </table>
  </div>

</div>
</div>

<!-- ‚úÖ POPUP BOX -->
<div id="popupOverlay">
  <div id="popupBox">

    <h5 class="text-center mb-3" id="popupTitle">‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>

    <input id="startDate" type="date" class="form-control mb-2">
    <input id="endDate" type="date" class="form-control mb-2">
    <input id="credit" type="number" class="form-control mb-2" placeholder="‡§ú‡§Æ‡§æ ‡§∞‡§æ‡§∂‡§ø (‚Çπ)">
    <input id="debit" type="number" class="form-control mb-2" placeholder="‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§∞‡§æ‡§∂‡§ø (‚Çπ)">
    <input id="interest" type="number" step="0.1" class="form-control mb-2" placeholder="‡§¨‡•ç‡§Ø‡§æ‡§ú (%)">
    <input id="days" type="number" class="form-control mb-2" placeholder="‡§¶‡§ø‡§®" readonly>
    <textarea id="note" class="form-control mb-3" placeholder="‡§®‡•ã‡§ü"></textarea>

    <button class="btn btn-success w-100 mb-2" onclick="saveLedgerEntry()">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
    <button class="btn btn-danger w-100" onclick="closePopup()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>

  </div>
</div>
<script>

/* ============================================
      ‚úÖ FIREBASE CONFIG
============================================ */

const firebaseConfig = {
  apiKey: "AIzaSyB30K96un0DsFbJ0-dx329za1HEnky3iC8",
  authDomain: "ms-saini.firebaseapp.com",
  databaseURL: "https://ms-saini-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ms-saini",
  storageBucket: "ms-saini.firebasestorage.app",
  messagingSenderId: "56761297643",
  appId: "1:56761297643:web:efbb8d890036191cfcacae",
  measurementId: "G-GP0P9C34RQ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();


/* ============================================
      GLOBAL VARIABLES
============================================ */
let currentCustomerId = null, editingCustomerId = null, editingEntryId = null;
let lastSearch = "", lastVillage = "";


/* ============================================
      SAFE HTML PRINTING
============================================ */
function escapeHtml(text){
  return String(text||"").replace(/[&<>"'`=\/]/g, s =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s])
  );
}


/* ============================================
   üî• TOTAL SUMMARY FOR ALL CUSTOMERS
============================================ */
function loadTotalSummary() {

  const ref = db.ref("ledgers");

  ref.once("value").then(snap => {

    let totalCredit = 0;
    let totalDebit = 0;
    let totalInterest = 0;

    snap.forEach(customer => {
      customer.forEach(entry => {
        const d = entry.val();

        totalCredit += Number(d.credit) || 0;
        totalDebit  += Number(d.debit) || 0;
        totalInterest += Number(d.interestAmount) || 0;
      });
    });

    let balance = (totalDebit + totalInterest) - totalCredit;

    document.getElementById("totalSummary").innerHTML = `
      <div>
        ‡§ï‡•Å‡§≤ ‡§ú‡§Æ‡§æ: ‚Çπ${totalCredit} |
        ‡§ï‡•Å‡§≤ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä: ‚Çπ${totalDebit} |
        ‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú: ‚Çπ${totalInterest.toFixed(2)} |
        ‡§ï‡•Å‡§≤ ‡§∂‡•á‡§∑: ‚Çπ${balance.toFixed(2)}
      </div>
    `;
  });
}


/* ============================================
   üî• AUTO INTEREST CALCULATION
============================================ */
document.getElementById("startDate").addEventListener("change", updateDaysAndInterest);
document.getElementById("endDate").addEventListener("change", updateDaysAndInterest);
document.getElementById("credit").addEventListener("input", updateDaysAndInterest);
document.getElementById("debit").addEventListener("input", updateDaysAndInterest);
document.getElementById("interest").addEventListener("input", updateDaysAndInterest);

function updateDaysAndInterest() {
  const sd = startDate.value;
  const ed = endDate.value;

  const c = +credit.value || 0;
  const d = +debit.value || 0;
  const r = +interest.value || 0;

  const dy = calculateDays(sd, ed);
  days.value = dy;

  const principal = c > 0 ? c : d > 0 ? d : 0;
  const iAmt = principal ? (principal * r * dy) / (100 * 30) : 0;

  document.getElementById("interestAmountPreview")?.remove();

  note.insertAdjacentHTML(
    "afterend",
    `<div id="interestAmountPreview" class="text-success fw-bold mb-2">
      ‡§¨‡•ç‡§Ø‡§æ‡§ú: ‚Çπ${iAmt.toFixed(2)}
     </div>`
  );
}


/* ============================================
   üî• LOAD ALL CUSTOMERS
============================================ */
function loadCustomers(nameFilter = "", villageFilter = "") {

  document.getElementById("totalSummary").style.display = "none";

  const ref = db.ref("customers");
  ref.off("value");

  ref.on("value", snap => {
document.getElementById("customerCount").innerText =
  "‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: " + snap.numChildren();
    const tbody = document.getElementById("customerTable");
    tbody.innerHTML = "";

    snap.forEach(child => {
      const d = child.val(), id = child.key;

      if (nameFilter && !d.name?.toLowerCase().includes(nameFilter.toLowerCase())) return;
      if (villageFilter && d.village !== villageFilter && villageFilter !== "") return;

   // üëâ ‡§®‡§æ‡§Æ ‡§∏‡•á Register No ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ
let fullName = d.name || "";
let match = fullName.match(/\d+$/);
let registerNo = match ? match[0] : "";
let cleanName = fullName.replace(/\s\d+$/, "");;
// üëâ ‡§®‡§à row ‡§¨‡§®‡§æ‡§è‡§Ç
const tr = document.createElement("tr");
tr.innerHTML = `
<td class="check-col">
  <input type="checkbox" class="customerCheckbox" value="${id}">
</td>

<td class="name-col">
  <b style="cursor:pointer;color:blue" class="open-ledger" data-id="${id}">
  ${escapeHtml(cleanName).replace(" ", "<br>")}
  </b>
</td>

<td class="reg-col">${registerNo}</td>

<td>${escapeHtml(d.father || "")}</td>
<td>${escapeHtml(d.village || "")}</td>
<td>${escapeHtml(d.phone || "")}</td>
<td>${escapeHtml(d.aadhar || "")}</td>

<td>
  <button class='btn btn-sm btn-primary' onclick="editCustomer('${id}')">‚úèÔ∏è</button>
  <button class='btn btn-sm btn-danger' onclick="deleteCustomer('${id}')">üóëÔ∏è</button>
</td>
`;
tbody.appendChild(tr);
    });

    document.querySelectorAll(".open-ledger").forEach(el => {
      el.onclick = () => openLedger(el.dataset.id);
    });
  });
}
loadCustomers();

/* Search + Filter */
document.getElementById("searchBox").addEventListener("input", e => {
  lastSearch = e.target.value.trim();
  loadCustomers(lastSearch, lastVillage);
});
document.getElementById("villageFilter").addEventListener("change", e => {
  lastVillage = e.target.value;
  loadCustomers(lastSearch, lastVillage);
});


/* ============================================
      ADD / EDIT CUSTOMER
============================================ */
function openAddCustomer() {
  editingCustomerId = null;
  cName.value = "";
  cFather.value = "";
  cVillage.value = "";
  cPhone.value = "";
  cAadhar.value = "";

  formHeader.innerText = "‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç";
  showCard("addCustomerCard");
}

function editCustomer(id) {
  editingCustomerId = id;

  db.ref("customers/" + id).once("value").then(snap => {
    const d = snap.val();

    cName.value = d.name;
    cFather.value = d.father;
    cVillage.value = d.village;
    cPhone.value = d.phone;
    cAadhar.value = d.aadhar;

    formHeader.innerText = "‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç";
    showCard("addCustomerCard");
  });
}

function saveCustomer() {
  const name = cName.value.trim();
  if (!name) return alert("‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç");

  const data = {
    name,
    father: cFather.value,
    village: cVillage.value,
    phone: cPhone.value,
    aadhar: cAadhar.value
  };

  if (editingCustomerId) {
    db.ref("customers/" + editingCustomerId).set(data)
      .then(() => { alert("‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‚úÖ"); backToList(); });
  } else {
    db.ref("customers").push(data)
      .then(() => { alert("‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ ‚úÖ"); backToList(); });
  }
}


/* ============================================
      DELETE CUSTOMER
============================================ */
function deleteCustomer(id) {
  if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§î‡§∞ ‡§â‡§∏‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

  db.ref("customers/" + id).remove()
    .then(() => db.ref("ledgers/" + id).remove())
    .then(() => { alert("‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úÖ"); loadCustomers(); });
}

function backToList(){ 
  totalSummary.style.display = "none";
  showCard("customerListCard"); 
  loadCustomers(lastSearch, lastVillage);
}


/* ============================================
      LEDGER OPEN
============================================ */
function openLedger(id){
  currentCustomerId = id;

  totalSummary.style.display = "none";

  db.ref("customers/" + id).once("value").then(snap => {
    ledgerCustomerName.innerText = snap.val().name;
    updateTopDate();
    showCard("ledgerCard");
    loadLedger();
  });
}


/* ============================================
      LOAD LEDGER ENTRY
============================================ */
function loadLedger() {
  const ref = db.ref("ledgers/" + currentCustomerId);
  ref.off("value");

  ref.on("value", snap => {

    ledgerTable.innerHTML = "";

    let totalC = 0, totalD = 0, totalI = 0;

    snap.forEach(entry => {
      const d = entry.val(), key = entry.key;

      totalC += +d.credit || 0;
      totalD += +d.debit || 0;
      totalI += +d.interestAmount || 0;

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${d.startDate}</td>
        <td>${d.endDate}</td>
        <td>‚Çπ${d.credit}</td>
        <td>‚Çπ${d.debit}</td>
        <td>${d.interest}%</td>
        <td>${d.days}</td>
        <td>‚Çπ${d.interestAmount}</td>
        <td>${escapeHtml(d.note||"")}</td>
        <td>
          <button class='btn btn-sm btn-primary' onclick="editLedgerEntry('${key}')">‚úèÔ∏è</button>
          <button class='btn btn-sm btn-danger' onclick="deleteLedgerEntry('${key}')">üóëÔ∏è</button>
        </td>
      `;
      ledgerTable.appendChild(tr);
    });

    const bal = (totalD + totalI) - totalC;

    ledgerFooter.innerHTML = `
      <tr class="total-row">
        <td colspan="2">‡§ï‡•Å‡§≤</td>
        <td>‚Çπ${totalC}</td>
        <td>‚Çπ${totalD}</td>
        <td colspan="2"></td>
        <td>‚Çπ${totalI.toFixed(2)}</td>
        <td colspan="2">‡§∂‡•á‡§∑ ‚Çπ${bal.toFixed(2)}</td>
      </tr>`;
  });
}


/* ============================================
      EDIT LEDGER ENTRY
============================================ */
function editLedgerEntry(key) {
  editingEntryId = key;

  db.ref("ledgers/" + currentCustomerId + "/" + key)
    .once("value").then(snap => {

      const d = snap.val();

      startDate.value = d.startDate;
      endDate.value = d.endDate;
      credit.value = d.credit;
      debit.value = d.debit;
      interest.value = d.interest;
      days.value = d.days;
      note.value = d.note;

      popupTitle.innerText = "‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç";
      popupOverlay.style.display = "flex";
    });
}


/* ============================================
      DELETE LEDGER ENTRY
============================================ */
function deleteLedgerEntry(key) {
  if (!confirm("‡§Ø‡§π ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§π‡§ü‡•á‡§ó‡§æ?")) return;

  db.ref("ledgers/" + currentCustomerId + "/" + key)
    .remove()
    .then(() => alert("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úÖ"));
}


/* ============================================
      SAVE LEDGER ENTRY
============================================ */
function calculateDays(s, e) {
  if (!s || !e) return 0;
  const d = (new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24);
  return d >= 0 ? Math.round(d) + 1 : 0;
}

function saveLedgerEntry() {

  const sd = startDate.value;
  const ed = endDate.value;

  const c = +credit.value || 0;
  const d = +debit.value || 0;
  const r = +interest.value || 0;

  const dy = calculateDays(sd, ed);

  const principal = c > 0 ? c : d > 0 ? d : 0;
  const iAmt = principal ? (principal * r * dy) / (100 * 30) : 0;

  const data = {
    startDate: sd,
    endDate: ed,
    credit: c,
    debit: d,
    interest: r,
    days: dy,
    interestAmount: iAmt.toFixed(2),
    note: note.value
  };

  const ref = editingEntryId
    ? db.ref("ledgers/" + currentCustomerId + "/" + editingEntryId)
    : db.ref("ledgers/" + currentCustomerId).push();

  ref.set(data).then(() => closePopup());
}

function openPopup() {
  editingEntryId = null;
  startDate.value = "";
  endDate.value = "";
  credit.value = "";
  debit.value = "";
  interest.value = "";
  days.value = "";
  note.value = "";

  popupTitle.innerText = "‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç";
  popupOverlay.style.display = "flex";
}

function closePopup() {
  popupOverlay.style.display = "none";
}


/* ============================================
      PRINT LEDGER
============================================ */
function printLedger() {

    let rawName = document.querySelector("#ledgerCustomerName").innerText.trim();

// ‡§®‡§æ‡§Æ ‡§ï‡•á ‡§Ü‡§ñ‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•ã ‡§®‡§Ç‡§¨‡§∞ ‡§π‡•à (register no) ‡§â‡§∏‡•á ‡§π‡§ü‡§æ‡§ì
let cleanName = rawName.replace(/\s\d+$/, "").trim();

const customerName = cleanName;
    // Date
    const d = new Date();
    const days = ["‡§∞‡§µ‡§ø","‡§∏‡•ã‡§Æ","‡§Æ‡§Ç‡§ó‡§≤","‡§¨‡•Å‡§ß","‡§ó‡•Å‡§∞‡•Å","‡§∂‡•Å‡§ï‡•ç‡§∞","‡§∂‡§®‡§ø"];
    const fullDate = `${days[d.getDay()]} | ${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;

    // ‚≠ê Clone Table
    let tableClone = document.querySelector("#ledgerTable").cloneNode(true);

    // ‚≠ê Remove last column (‡§ï‡§æ‡§∞‡•ç‡§Ø)
    tableClone.querySelectorAll("tr").forEach(row => {
        if (row.cells.length > 8) {     // 9th column ‡§π‡§ü‡§æ‡§®‡§æ
            row.deleteCell(8);
        }
    });

    // ‚≠ê Clone Footer
    let footerClone = document.querySelector("#ledgerFooter").cloneNode(true);
    footerClone.querySelectorAll("tr").forEach(row => {
        if (row.cells.length > 8) {
            row.deleteCell(8);
        }
    });

    // Print window
    const w = window.open("", "", "width=900,height=700");

    w.document.write(`
    <html>
    <head>
        <title>Ledger Print</title>
        <style>
            body { font-family: Poppins, sans-serif; padding:20px; }
            table { width:100%; border-collapse: collapse; margin-top:10px; }
            table, th, td { border:1px solid black; }
            th, td { padding:6px; font-size:14px; text-align:center; }
        </style>
    </head>

    <body>

        <h3 class="text-center">‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä</h3>

        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <b>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: ${customerName}</b>
            <b>‡§§‡§æ‡§∞‡•Ä‡§ñ: ${fullDate}</b>
        </div>

        <table>
            <thead>
                <tr>
                    <th>‡§∂‡•Å‡§∞‡•Ç</th>
                    <th>‡§Ö‡§Ç‡§§</th>
                    <th>‡§ú‡§Æ‡§æ</th>
                    <th>‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä</th>
                    <th>‡§¨‡•ç‡§Ø‡§æ‡§ú (%)</th>
                    <th>‡§¶‡§ø‡§®</th>
                    <th>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§æ‡§∂‡§ø</th>
                    <th>‡§®‡•ã‡§ü</th>
                </tr>
            </thead>

            <tbody>
                ${tableClone.innerHTML}
            </tbody>

            <tfoot>
                ${footerClone.innerHTML}
            </tfoot>
        </table>

    </body>
    </html>
    `);

    w.document.close();

    setTimeout(() => w.print(), 300);
}
/* ============================================
      ADD NEW VILLAGE
============================================ */
function addNewVillage(){
  const v = prompt("‡§®‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:");
  if(!v) return;

  // üëâ ‡§∏‡§π‡•Ä Firebase Path
  db.ref("settings/villages").push(v);

  alert("‡§ó‡§æ‡§Å‡§µ ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úî");

  // Dropdown ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
  const s = cVillage;
  const vf = villageFilter;

  let o = document.createElement("option");
  o.text = v; o.value = v;  
  s.appendChild(o);

  let o2 = document.createElement("option");
  o2.text = v; o2.value = v;
  vf.appendChild(o2);

  s.value = v;
}
function loadVillages() {
  db.ref("settings/villages").on("value", snap => {

    cVillage.innerHTML =
      '<option value="">\u0917\u093E\u0901\u0935 \u091A\u0941\u0928\u0947\u0902</option>';

    villageFilter.innerHTML =
      '<option value="">\u0938\u092D\u0940 \u0917\u093E\u0901\u0935</option>';

    snap.forEach(item => {
      const name = item.val();  // ‚≠ê‚≠ê FIXED ‚≠ê‚≠ê

      let o1 = document.createElement("option");
      o1.text = name;
      o1.value = name;
      cVillage.appendChild(o1);

      let o2 = document.createElement("option");
      o2.text = name;
      o2.value = name;
      villageFilter.appendChild(o2);
    });

  });
}
/* ============================================
      EXCEL IMPORT
============================================ */
document.getElementById("excelUpload")
    .addEventListener("change", handleExcelUpload);

function handleExcelUpload(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ev => {

    try {
      const workbook = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      let count = 0;

      rows.forEach(r => {
        if(r["‡§®‡§æ‡§Æ"] || r["Name"]){
          db.ref("customers").push({
            name: r["‡§®‡§æ‡§Æ"] || r["Name"],
            father: r["‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ"] || r["Father"] || "",
            village: r["‡§ó‡§æ‡§Å‡§µ"] || r["Village"] || "",
            phone: r["‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤"] || r["Phone"] || "",
            aadhar: r["‡§Ü‡§ß‡§æ‡§∞"] || r["Aadhar"] || ""
          });
          count++;
        }
      });

      alert(count + " ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§ø‡§è ‡§ó‡§è ‚úÖ");
      loadCustomers();
    }
    catch(err){
      alert("‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
    }

    e.target.value = "";
  };

  reader.readAsArrayBuffer(file);
}


/* ============================================
      DELETE SELECTED CUSTOMERS
============================================ */
function toggleSelectAll(main){
  document.querySelectorAll(".customerCheckbox")
    .forEach(cb => cb.checked = main.checked);
}

function deleteSelectedCustomers(){
  const arr = [...document.querySelectorAll(".customerCheckbox:checked")]
                .map(cb => cb.value);

  if(arr.length == 0) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
  if(!confirm("‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§®‡•á ‡§π‡•à‡§Ç?")) return;

  arr.forEach(id => {
    db.ref("customers/" + id).remove();
    db.ref("ledgers/" + id).remove();
  });

  alert("‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§è ‡§ó‡§è ‚úÖ");
  loadCustomers();
}


/* ============================================
      DELETE ALL CUSTOMERS
============================================ */
function deleteAllCustomers(){
  if(!confirm("‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§î‡§∞ ‡§â‡§®‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

  db.ref("customers").remove()
    .then(() => db.ref("ledgers").remove())
    .then(() => {
      alert("‚úÖ ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§è ‡§ó‡§è!");
      loadCustomers();
    });
}


/* ============================================
      PRINT CUSTOMER LIST
============================================ */
function printCustomers() {

    // ‡§™‡•Ç‡§∞‡§æ customer table clone ‡§ï‡§∞‡•ã
    let tableClone = document.querySelector("#customerTable").cloneNode(true);

    // Checkbox ‡§π‡§ü‡§æ‡§ì
    tableClone.querySelectorAll(".check-col").forEach(col => col.remove());

    // Edit/Delete ‡§π‡§ü‡§æ‡§ì
    tableClone.querySelectorAll("td:last-child, th:last-child").forEach(col => col.remove());

    // Date + Count
    const d = new Date();
    const days = ["‡§∞‡§µ‡§ø","‡§∏‡•ã‡§Æ","‡§Æ‡§Ç‡§ó‡§≤","‡§¨‡•Å‡§ß","‡§ó‡•Å‡§∞‡•Å","‡§∂‡•Å‡§ï‡•ç‡§∞","‡§∂‡§®‡§ø"];
    const fullDate = `${days[d.getDay()]} | ${d.getDate()}-${d.getMonth() + 1}-${d.getFullYear()}`;
    const count = document.getElementById("customerCount").innerText;

    // Print Window
    const w = window.open("", "", "width=900,height=700");

    w.document.write(`
    <html>
    <head>
        <title>Customer List</title>
        <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

        <style>
            body { font-family: Poppins, sans-serif; padding:20px; }
            table, th, td { border:1px solid black !important; border-collapse: collapse; }
            th, td { padding:6px; font-size:13px; text-align:center; }
            table { width:100%; margin-top:10px; }
        </style>
    </head>

    <body>

        <h4 class="text-center mb-1">‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä</h4>

        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <b>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä</b>
            <b>‡§§‡§æ‡§∞‡•Ä‡§ñ: ${fullDate}</b>
        </div>

        <div class="text-center mb-2" style="color:red; font-weight:bold;">
            ${count}
        </div>

        <table class="table table-bordered text-center">
            <thead class="table-warning">
                <tr>
                    <th>‡§®‡§æ‡§Æ</th>
                    <th>‡§∞.‡§®.</th>
                    <th>‡§™‡•Å‡§§‡•ç‡§∞</th>
                    <th>‡§ó‡§æ‡§Å‡§µ</th>
                    <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                    <th>‡§Ü‡§ß‡§æ‡§∞</th>
                </tr>
            </thead>
            <tbody>
                ${tableClone.innerHTML}
            </tbody>
        </table>

    </body>
    </html>
    `);

    w.document.close();
    setTimeout(() => { w.print(); }, 400);
}
    

/* ============================================
      DATE SYSTEM (TOP + MAIN)
============================================ */
function updateTopDate() {
    const d = new Date();
    const days = ["‡§∞‡§µ‡§ø","‡§∏‡•ã‡§Æ","‡§Æ‡§Ç‡§ó‡§≤","‡§¨‡•Å‡§ß","‡§ó‡•Å‡§∞‡•Å","‡§∂‡•Å‡§ï‡•ç‡§∞","‡§∂‡§®‡§ø"];
    const day = days[d.getDay()];
    const date = d.getDate().toString().padStart(2,'0');
    const month = (d.getMonth()+1).toString().padStart(2,'0');
    const year = d.getFullYear();
    topDate.innerText = `${day} | ${date}-${month}-${year}`;
}
updateTopDate();

function updateMainDate() {
    const d = new Date();
    const days = ["‡§∞‡§µ‡§ø","‡§∏‡•ã‡§Æ","‡§Æ‡§Ç‡§ó‡§≤","‡§¨‡•Å‡§ß","‡§ó‡•Å‡§∞‡•Å","‡§∂‡•Å‡§ï‡•ç‡§∞","‡§∂‡§®‡§ø"];
    const day = days[d.getDay()];
    const date = d.getDate().toString().padStart(2,'0');
    const month = (d.getMonth()+1).toString().padStart(2,'0');
    const year = d.getFullYear();
    mainDate.innerText = `${day} | ${date}-${month}-${year}`;
}
updateMainDate();


/* ============================================
      CARD SWITCH SYSTEM
============================================ */

// ‚≠ê ‡§´‡§ø‡§Ç‡§ó‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞
async function fingerLogin() {
    if (!window.PublicKeyCredential) {
        alert("‚ùå ‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç Fingerprint ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
        return;
    }

    // üëâ store ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•Å‡§Ü passkey id ‡§≤‡•ã
    const keyIdBase64 = localStorage.getItem("passkeyId");

    if (!keyIdBase64) {
        alert("‚ö†Ô∏è ‡§™‡§π‡§≤‡•á Register Fingerprint ‡§¶‡§¨‡§æ‡§è‡§Å");
        return;
    }

    // üëâ base64 ‚Üí original Uint8Array ‡§Æ‡•á‡§Ç convert
    const keyId = Uint8Array.from(atob(keyIdBase64), c => c.charCodeAt(0));

    const challenge = new Uint8Array(32);
    window.crypto.getRandomValues(challenge);

    try {
        await navigator.credentials.get({
            publicKey: {
                challenge,
                timeout: 60000,
                userVerification: "required",
                allowCredentials: [{
                    id: keyId,          // ‚≠ê ‡§∏‡§¨‡§∏‡•á Important Line
                    type: "public-key"
                }]
            }
        });

        alert("üîì Fingerprint Login Success!");

        localStorage.setItem("auth", "yes");

        loginScreen.style.display = "none";
        customerListCard.style.display = "block";

    } catch (error) {
        console.error(error);
        alert("‚ùå Fingerprint Login Fail");
    }
}
function showCard(id){

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("customerListCard").style.display = "none";
    document.getElementById("addCustomerCard").style.display = "none";
    document.getElementById("ledgerCard").style.display = "none";

    document.getElementById(id).style.display = "block";
}
window.onload = function() {
    loadVillages();
};;

// ‚≠ê‚≠ê‚≠ê ‡§Ø‡§π‡•Ä ‡§®‡•Ä‡§ö‡•á Village Manager ‡§ï‡§æ JS paste ‡§ï‡§∞‡§®‡§æ ‡§π‡•à ‚≠ê‚≠ê‚≠ê

/* ============================
   ‚≠ê Village Manager Functions
============================ */

function openVillageManager() {
    document.getElementById("villagePopup").style.display = "flex";

    const list = document.getElementById("villageList");
    list.innerHTML = "";

    db.ref("settings/villages").once("value").then(snap => {
        snap.forEach(item => {
            const key = item.key;
            const name = item.val();

            list.innerHTML += `
                <li class='list-group-item d-flex justify-content-between align-items-center'>
                    ${name}
                    <div>
                        <button class='btn btn-sm btn-primary me-2' onclick="editVillage('${key}', '${name}')">‚úèÔ∏è</button>
                        <button class='btn btn-sm btn-danger' onclick="deleteVillage('${key}')">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        });
    });
}

function closeVillageManager() {
    document.getElementById("villagePopup").style.display = "none";
}

function editVillage(key, oldName) {
    const newName = prompt("‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:", oldName);
    if (!newName) return;

    db.ref("settings/villages/" + key).set(newName);

    alert("‡§ó‡§æ‡§Å‡§µ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§Ü ‚úî");

    openVillageManager();
    loadVillages();
}

function deleteVillage(key) {
    if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ ‡§π‡§ü‡§æ‡§®‡§æ ‡§π‡•à?")) return;

    db.ref("settings/villages/" + key).remove();

    alert("‡§ó‡§æ‡§Å‡§µ ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‚úî");

    openVillageManager();
    loadVillages();
}
/* üîç TOTAL SUMMARY TOGGLE SYSTEM */

function toggleSummary() {
    const box = document.getElementById("totalSummary");

    if (box.style.display === "none" || box.style.display === "") {
        loadTotalSummary();   // ‚≠ê ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•ã
        box.style.display = "block";
    } else {
        box.style.display = "none";
    }
}
</script> 
</body>
<html>