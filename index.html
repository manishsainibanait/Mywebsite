<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä</title>

<!-- Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<!-- Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
/* ===== PROFESSIONAL COLOURFUL SEARCH + FILTER ===== */

/* üîµ ‡§®‡§æ‡§Æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç */
#searchBox{
  border:2px solid #60a5fa;
  border-radius:10px;
  padding:10px;
  font-weight:600;
  background:#f0f7ff;
}
#searchBox:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,.25);
  background:white;
}

/* üü° ‡§ó‡§æ‡§Å‡§µ filter */
#villageFilter{
  border:2px solid #facc15;
  border-radius:10px;
  padding:10px;
  font-weight:600;
  background:#fffbea;
}
#villageFilter:focus{
  outline:none;
  border-color:#eab308;
  box-shadow:0 0 0 3px rgba(234,179,8,.25);
  background:white;
}

/* ===== TABLE PROFESSIONAL LOOK ===== */
thead th{
  background:linear-gradient(180deg,#eaf2ff,#dbeafe);
  color:#1e3a8a;
  font-weight:700;
  position:sticky;
  top:0;
  z-index:20;
}
/* GLOBAL */
body { background:#f8fafc; padding:20px; font-family:'Poppins',sans-serif; }
.card { border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.12); margin-bottom:20px; }
.header {
    background:#0d6efd;
    color:white;
    text-align:center;
    padding:12px;
    border-radius:15px 15px 0 0;
    font-weight:600;
    font-size:1.2rem;
    position: relative;   /* ‚≠ê ‡§Ø‡§π‡•Ä ‡§°‡§æ‡§≤‡§®‡§æ ‡§π‡•à */
}
.sub-header { background:#ffc107; padding:6px; text-align:center;
              font-weight:600; border-radius:0 0 15px 15px; }
.btn { border-radius:8px; font-weight:600; }
table { font-size:0.9rem; }

/* üåæ ‡§´‡§∏‡§≤ Display ‡§¨‡•â‡§ï‡•ç‡§∏ */
.fasal-note-box {
    background:#fff8d6; padding:12px; border-radius:10px;
    border-left:6px solid #f4c542; line-height:1.4;
    white-space:pre-line; font-size:14px;
}

/* üåæ Multi-Fasal Collapsible	UI */
.fasal-box {
    background:#fff8d6; border:2px solid #f4c542;
    padding:12px; border-radius:12px; margin-top:6px;
    white-space:pre-line;
}
.fasal-head {
    background:#ffe8a3; padding:6px 10px; border-radius:6px;
    cursor:pointer; font-weight:600;
}
.fasal-detail { display:none; }
/* === 3D METAL BLUE BACK BUTTON === */
.back-3d-btn {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);

    padding: 10px 22px;
    border-radius: 40px;

    background: linear-gradient(145deg, #6eb0ff, #2b7cff);
    border: 4px solid #dcdcdc;

    box-shadow:
        inset 0 4px 7px rgba(255,255,255,0.9),
        inset 0 -4px 7px rgba(0,0,0,0.25),
        0 6px 14px rgba(0,0,0,0.35),
        0 0 6px rgba(255,255,255,0.8);

    display: flex;
    align-items: center;
    justify-content: center;

    color: white;
    font-size: 22px;
    font-weight: 700;

    height: 45px;
    width: 85px;

    cursor: pointer;
    transition: 0.2s ease;
}

.back-3d-btn:active {
    transform: translateY(-50%) scale(0.96);
}
/* Customer table freeze columns */
th.check-col, td.check-col {
    position:sticky; left:0; background:white; z-index:30;
}
th.name-col{
    position:sticky;
    left:35px;
    background:linear-gradient(180deg,#eaf2ff,#dbeafe);
    color:#1e3a8a;
    z-index:31;
}

td.name-col{
    position:sticky;
    left:35px;
    background:white;
    z-index:29;
}
    white-space:normal; line-height:1.1;
    min-width:95px; max-width:95px;
}
th.reg-col, td.reg-col {
    width:55px !important; text-align:center; font-weight:bold;
}

/* Popup */
#popupOverlay, #fasalPopupOverlay, #villagePopup {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); display:none;
    justify-content:center; align-items:center; z-index:3000;
}
#popupBox {
    background:white; padding:20px; border-radius:12px;
    width:90%; max-width:420px;
}

/* ‚úÖ PRINT FIX */
@media print {
#customerTableContainer {
    max-height: none !important;
    overflow: visible !important;
}
    /* Login screen hide */
    #loginScreen {
        display: none !important;
    }

    /* Header‚Äìbuttons hide */
    .btn, button, select, input {
        display: none !important;
    }

    /* Fasals ke upar wale ‡§¨‡§°‡§º‡•á ‡§¨‡•â‡§ï‡•ç‡§∏ hide */
    .summary-card,
    .total-fasal-wrapper,
    .fasal-summary-box,
    .fasal-box {
        display: none !important;
    }

    /* PDF ‡§Æ‡•á‡§Ç ‡§∞‡§Ç‡§ó ‡§∏‡§π‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
    body {
        -webkit-print-color-adjust: exact !important;
        background: white !important;
    }

    /* Table ‡§™‡•Ç‡§∞‡§æ ‡§¶‡§ø‡§ñ‡•á */
    table, tr, td, th {
        color: #000 !important;
        background: white !important;
    }
}
td.name-col span {
    font-weight: 800 !important;
}
/* ‡§Ø‡§π‡§æ‡§Å ‡§§‡•á‡§∞‡•á ‡§¨‡§æ‡§ï‡•Ä CSS ‡§π‡•à‡§Ç... */

/* ‡§Ø‡§π‡§æ‡§Å PRINT FIX ‡§°‡§æ‡§≤‡§®‡§æ ‡§π‡•à  =================== */
@media print {

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  html, body {
    height: auto !important;
    overflow: visible !important;
  }

  .card {
    page-break-inside: avoid !important;
  }

  table {
    page-break-inside: auto !important;
  }

  tr, td, th {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
  }

  #customerListCard {
    max-height: none !important;
    overflow: visible !important;
  }

}
/* ============================================= */
.hide-duplicate{
  display:none !important;
}
/* ‚ò∞ MENU click fix */
.dropdown{
  position: relative;
  z-index: 9999;
}
#searchBox::placeholder{
  color:#374151;
}
#customerTable tr:hover{
  background:#f1f5ff;
}
#villageFilter option{
  font-weight:600;
}
.customer-count-card{
  display:flex;
  align-items:center;
  gap:14px;
  margin:12px;
  padding:14px 18px;
  background:linear-gradient(135deg,#e0f2ff,#f8fbff);
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  border-left:6px solid #0d6efd;
}

.cc-icon{
  width:46px;
  height:46px;
  border-radius:50%;
  background:#0d6efd;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:white;
}

.cc-label{
  font-size:14px;
  color:#1e3a8a;
  font-weight:600;
}

.cc-number{
  font-size:22px;
  font-weight:800;
  color:#0d6efd;
}
.count-header{
  background:#eaf2ff;
  color:#1e3a8a;
  font-weight:700;
  text-align:center;
  padding:8px;
  border-bottom:2px solid #0d6efd;
  font-size:15px;
}
.count-sub{
  background:#f1f5ff;     /* ‡§π‡§≤‡•ç‡§ï‡§æ blue */
  color:#1e3a8a;
  font-size:14px;
  font-weight:600;
  border-top:1px solid #dbeafe;
}
/* ===== PROFESSIONAL MENU BUTTON ===== */
.menu-btn{
  background: linear-gradient(135deg,#1e88e5,#0d47a1);
  color:white;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:6px;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
}

.menu-btn:focus,
.menu-btn:active{
  box-shadow:0 0 0 3px rgba(30,136,229,.35);
}

.menu-btn i{
  font-size:18px;
}
/* ‚ùå Popup ke andar main menu hide */
#villagePopup .main-menu {
  display: none !important;
}
/* ‚ùå ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® Popup ‡§Æ‡•á‡§Ç Menu hide */
#villagePopup .dropdown,
#villagePopup .menu-btn {
  display: none !important;
}
#villagePopup{
  z-index: 9999;
}

#villagePopupBox{
  z-index: 10000;
}
</style>
</head>


<body>

<!-- üîê LOGIN SCREEN -->
<div id="loginScreen" style="
    width:100%; max-width:400px; margin:40px auto;
    background:white; padding:25px; border-radius:15px;
    box-shadow:0 4px 10px rgba(0,0,0,0.25);">

  <h3 class="text-center mb-3">üîê ‡§≤‡•â‡§ó‡§ø‡§®</h3>

  <input id="loginPass" type="password"
         class="form-control mb-3"
         placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">

  <button class="btn btn-primary w-100 mb-2" onclick="loginNow()">‡§≤‡•â‡§ó‡§ø‡§®</button>
  <button class="btn btn-danger w-100 mb-2" onclick="showForgot()">‚ùì ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?</button>

  <button class="btn btn-warning w-100 mb-2" onclick="registerFinger()">üîë ‡§´‡§ø‡§Ç‡§ó‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞</button>
  <button class="btn btn-success w-100" onclick="fingerLogin()">üîí ‡§´‡§ø‡§Ç‡§ó‡§∞ ‡§≤‡•â‡§ó‡§ø‡§®</button>
</div>

<!-- üîë FORGOT PASSWORD BOX -->
<div id="forgotBox" style="
    display:none; width:100%; max-width:400px;
    margin:40px auto; background:white; padding:20px;
    border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.25);">

  <h4 class="text-center mb-3">üîë ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü</h4>

  <input id="favName" class="form-control mb-2"
         placeholder="‡§´‡•á‡§µ‡§∞‡•á‡§ü ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç">

  <button class="btn btn-success w-100" onclick="resetPass()">Reset ‡§ï‡§∞‡•á‡§Ç</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="hideForgot()">‡§µ‡§æ‡§™‡§∏</button>

</div>
<!-- ‚≠ê CUSTOMER LIST SCREEN -->
<div id="customerListCard" class="card" style="display:none">
  <div class="header">

    <button onclick="logoutNow()" class="btn btn-light btn-sm" style="float:left">
      üö™ Logout
    </button>

    ‡§∏‡•à‡§®‡•Ä ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Ç‡§™‡§®‡•Ä

    <span id="mainDate" style="float:right; font-size:14px;"></span>
  </div>

<div class="sub-header">
  ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä
  <span style="
    font-weight:700;
    font-size:16px;
    color:#0d47a1;
    margin-left:6px;
  ">
    (‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï :
    <span id="customerCount" style="color:#c62828;font-weight:800;">
      0
    </span>)
  </span>
</div>


  <!-- ‡§ï‡•Å‡§≤ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï -->
  
  <!-- ‚ò∞ MENU -->
<div class="d-flex justify-content-start px-3 mt-2 mb-4">
  <div class="dropdown">
    <button class="menu-btn dropdown-toggle"
        type="button"
        data-bs-toggle="dropdown">
  <i class="bi bi-list"></i> ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç
</button>

    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="#" onclick="openVillageManager()">üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</a></li>
      <li><a class="dropdown-item" href="#" onclick="toggleSummary()">üîç ‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</a></li>
      <li><a class="dropdown-item" href="#" onclick="deleteSelectedCustomers()">üóë ‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§è‡§Ç</a></li>
      <li><a class="dropdown-item" href="#" onclick="openAddCustomer()">‚ûï ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</a></li>
      <li><a class="dropdown-item" href="#" onclick="document.getElementById('excelUpload').click()">üì§ Excel ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§≤‡•ã‡§°</a></li>
      <li><a class="dropdown-item" href="#" onclick="printCustomers()">üñ® ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</a></li>
    </ul>
  </div>
</div>
    <!-- ‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¨‡§ü‡§® -->
    <button class="btn btn-info w-100 mb-2 hide-duplicate" onclick="toggleSummary()">
      üîç ‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂
    </button>

    <!-- ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¨‡•â‡§ï‡•ç‡§∏ -->
    <div id="totalSummary"
         class="alert alert-info text-center fw-bold mb-3"
         style="display:none">
      <!-- JS ‡§∏‡•á ‡§≠‡§∞‡•á‡§ó‡§æ -->
    </div>

    <!-- ‡§ó‡§æ‡§Å‡§µ ‡§Æ‡•à‡§®‡•á‡§ú‡§∞ -->
   <button class="btn btn-dark w-100 mb-3 hide-duplicate" onclick="openVillageManager()">
      üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (Edit / Delete)
    </button>

    <!-- ‡§∏‡§∞‡•ç‡§ö + ‡§ó‡§æ‡§Å‡§µ ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞ -->
  <div class="row mb-3 mt-2">
      <div class="col-6">
        <input id="searchBox"
               class="form-control"
               placeholder="‡§®‡§æ‡§Æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
      </div>
      <div class="col-6">
        <select id="villageFilter" class="form-select">
          <option value="">‡§∏‡§≠‡•Ä ‡§ó‡§æ‡§Å‡§µ</option>
        </select>
      </div>
    </div>

    <!-- Delete buttons -->
    <div class="d-flex gap-2 mb-3">
    <button class="btn btn-danger flex-fill hide-duplicate" onclick="deleteSelectedCustomers()">
        üóë ‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§π‡§ü‡§æ‡§è‡§Ç
      </button>
 
    </div>

    <!-- ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï / ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü / ‡§è‡§ï‡•ç‡§∏‡•á‡§≤ -->
    <button class="btn btn-success w-100 mb-3 hide-duplicate" onclick="openAddCustomer()">
      + ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    </button>

  <button class="btn btn-secondary w-100 mb-3 hide-duplicate" onclick="printCustomers()">
      üñ® ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
    </button>

    <input type="file" id="excelUpload"
           accept=".xlsx,.xls,.csv"
           class="form-control mb-3"
           style="display:none">

  <button class="btn btn-warning w-100 mb-3 hide-duplicate"
        onclick="document.getElementById('excelUpload').click()">
      üì§ Excel ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
    </button>

    <!-- ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ü‡•á‡§¨‡§≤ -->
    <div id="customerTableContainer"
         class="table-responsive"
         style="max-height:65vh; overflow-y:auto;">

      <table class="table table-bordered text-center align-middle">
      <thead>
          <tr>
            <th class="check-col">
              <input type="checkbox" id="selectAll"
                     onchange="toggleSelectAll(this)">
            </th>
            <th class="name-col">‡§®‡§æ‡§Æ</th>
            <th class="reg-col">‡§∞.‡§®.</th>
            <th>‡§™‡•Å‡§§‡•ç‡§∞</th>
            <th>‡§ó‡§æ‡§Å‡§µ</th>
            <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
            <th>‡§Ü‡§ß‡§æ‡§∞</th>
            <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
          </tr>
        </thead>
        <tbody id="customerTable"></tbody>
      </table>

    </div>

  </div>
</div>

<!-- ‚≠ê ADD CUSTOMER SCREEN -->
<div id="addCustomerCard" class="card" style="display:none">
  <div class="header" id="formHeader">‚ûï ‡§®‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>

  <div class="card-body">

    <input id="cName"   class="form-control mb-2" placeholder="‡§®‡§æ‡§Æ">
    <input id="cFather" class="form-control mb-2" placeholder="‡§™‡•Å‡§§‡•ç‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ">

    <div class="input-group mb-2">
      <select id="cVillage" class="form-select">
        <option value="">‡§ó‡§æ‡§Å‡§µ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
      </select>
      <button class="btn btn-outline-secondary"
              type="button"
              onclick="addNewVillage()">+
      </button>
    </div>

    <input id="cPhone"  class="form-control mb-2" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞">
    <input id="cAadhar" class="form-control mb-3" placeholder="‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞">
<input id="cRN" class="form-control mb-3" placeholder="‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§®‡§Ç‡§¨‡§∞ (R.N.)">
    <button class="btn btn-success w-100 mb-2" onclick="saveEditedCustomer()">
‚úî ‡§∏‡§π‡•á‡§ú‡•á‡§Ç
</button>

<button class="btn btn-secondary w-100" onclick="backToList()">
üîô ‡§µ‡§æ‡§™‡§∏
</button>
  </div>
</div>

<!-- ‚≠ê Village Manager Popup -->
<div id="villagePopup">
  <div id="fasalPopupBox">

    <h4 class="text-center mb-3">üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h4>

    <ul id="villageList" class="list-group mb-3"></ul>

    <button class="btn btn-success w-100 mb-2" onclick="addNewVillage()">
      + ‡§®‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    </button>

    <button class="btn btn-secondary w-100" onclick="closeVillageManager()">
      ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
    </button>

  </div>
</div>
<!-- ‚≠ê FASAL MANAGER POPUP -->
<div id="fasalManagerPopup" style="display:none;
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:3000;">
  
  <div style="background:white;padding:20px;border-radius:12px;
      width:90%;max-width:400px;">

    <h4 class="text-center mb-3">üåæ ‡§´‡§∏‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h4>

    <input id="newFasalName" class="form-control mb-2" placeholder="‡§®‡§à ‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ">

    <button class="btn btn-success w-100 mb-3" onclick="addNewFasal()">
      + ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
    </button>

    <div id="fasalList" style="max-height:300px;overflow-y:auto;"></div>

    <button class="btn btn-danger w-100 mt-3" onclick="closeFasalManager()">
      ‚ùå ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
    </button>
  </div>
</div>
<!-- ‚≠ê LEDGER SCREEN -->
<div id="ledgerCard" class="card" style="display:none">
 <div class="header">
    üìò ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§≤‡•á‡§ú‡§∞

    <button class="btn btn-light float-end btn-sm" onclick="backToList()">üîô ‡§µ‡§æ‡§™‡§∏</button>
        ‚Üê
    </button>
</div>

  <div class="sub-header" id="ledgerCustomerName"></div>

  <div class="card-body">

    <div class="d-flex gap-2 mb-3">

    <button class="btn btn-primary flex-fill" onclick="openTransactionPopup()">+ ‡§≤‡•á‡§®-‡§¶‡•á‡§®</button>

    <button class="btn btn-success flex-fill" onclick="openFasalPopup()">üåæ ‡§´‡§∏‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>

    <!-- ‚≠ê ‡§®‡§Ø‡§æ ‡§¨‡§ü‡§® ‡§Ø‡§π‡§æ‡§Å -->
    <button class="btn btn-warning flex-fill" onclick="openFasalManager()">üåæ ‡§´‡§∏‡§≤ ‡§≤‡§ø‡§∏‡•ç‡§ü</button>

    <button class="btn btn-secondary flex-fill" onclick="printLedger()">üñ® ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>

</div>

    <!-- ‚≠ê Multi Fasal Summary Box (Collapsible) -->
    <div class="fasal-box">
        <div class="fasal-head" onclick="toggleFasalSummary()">üìä ‡§ï‡•Å‡§≤ ‡§´‡§∏‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Tap)</div>
        <div id="fasalSummary" class="fasal-detail"></div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-bordered text-center">
        <thead class="table-warning">
  <tr>
    <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
    <th>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ</th>   <!-- ‚≠ê ‡§®‡§Ø‡§æ END DATE column -->
    <th>‡§ú‡§Æ‡§æ</th>
    <th>‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä</th>
    <th>‡§¨‡•ç‡§Ø‡§æ‡§ú %</th>
    <th>‡§¶‡§ø‡§®</th>
    <th>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§æ‡§∂‡§ø</th>
    <th>‡§´‡§∏‡§≤</th>
    <th>‡§®‡•ã‡§ü</th>
    <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
  </tr>
</thead>
        <tbody id="ledgerTable"></tbody>
        <tfoot id="ledgerFooter"></tfoot>
      </table>
    </div>

  </div>
</div>


<!-- ‚≠ê NORMAL TRANSACTION POPUP -->
<div id="transactionPopupOverlay"
     style="position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:none;
            justify-content:center; align-items:center; z-index:2000;">
  <div id="popupBox">

    <h5 class="text-center mb-3">üßæ ‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§®</h5>
<input id="tDate" type="date" class="form-control mb-2" placeholder="‡§∂‡•Å‡§∞‡•Ç ‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º">
    <input id="tEndDate" type="date" class="form-control mb-2" placeholder="‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ‡§º">
    <input id="tCredit" type="number" class="form-control mb-2" placeholder="‡§ú‡§Æ‡§æ (‚Çπ)">
    <input id="tDebit" type="number" class="form-control mb-2" placeholder="‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä (‚Çπ)">
    <input id="tInterest" type="number" class="form-control mb-2" placeholder="‡§¨‡•ç‡§Ø‡§æ‡§ú (%)">
   <input id="tDays" type="number" class="form-control mb-2" placeholder="‡§¶‡§ø‡§®" readonly>

<input id="tInterestAmount" type="number" class="form-control mb-2" placeholder="‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§æ‡§∂‡§ø (‚Çπ)" readonly>

<textarea id="tNote" class="form-control mb-3" placeholder="‡§®‡•ã‡§ü"></textarea>

    <button class="btn btn-success w-100 mb-2" onclick="saveTransaction()">‚úî ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
    <button class="btn btn-danger w-100" onclick="closeTransactionPopup()">‡§∞‡§¶‡•ç‡§¶</button>
  </div>
</div>


<!-- ‚≠ê FASAL POPUP -->
<div id="fasalPopupOverlay"
     style="position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:none;
            justify-content:center; align-items:center; z-index:2000;">
  <div id="popupBox">

    <h5 class="text-center mb-3">üåæ ‡§®‡§à ‡§´‡§∏‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>
<input id="fDate" type="date" class="form-control mb-2">

    <select id="fName" class="form-select mb-2">
      <option value="">‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
      <option>‡§∏‡§∞‡§∏‡•ã‡§Ç</option>
      <option>‡§ó‡•á‡§π‡•Ç‡§Ç</option>
      <option>‡§¨‡§æ‡§ú‡§∞‡§æ</option>
      <option>‡§ß‡§æ‡§®</option>
      <option>‡§ö‡§®‡§æ</option>
      <option>‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä</option>
    </select>

    <div class="row">
      <div class="col-6">
        <input id="fBori" type="number" class="form-control mb-2" placeholder="‡§¨‡•ã‡§∞‡§ø‡§Ø‡§æ‡§Å">
      </div>
      <div class="col-6">
        <input id="fWeightPer" type="number" class="form-control mb-2" placeholder="1 ‡§¨‡•ã‡§∞‡•Ä KG">
      </div>
    </div>
<input id="fExtraKG" type="number" class="form-control mb-2" placeholder="‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ KG">
    <input id="fTotalQ" class="form-control mb-2" placeholder="‡§ï‡•Å‡§≤ ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤" readonly>

    <input id="fRate" type="number" class="form-control mb-2" placeholder="‡§≠‡§æ‡§µ ‚Çπ/Q">
    <input id="fMajduri" type="number" class="form-control mb-2" placeholder="‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä ‚Çπ/Q">

    <input id="fCutOther" type="number" class="form-control mb-2" placeholder="‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§ü‡•å‡§§‡•Ä (‚Çπ)">
    <input id="fCutTotal" class="form-control mb-2" placeholder="‡§ï‡•Å‡§≤ ‡§ï‡§ü‡•å‡§§‡•Ä" readonly>

    <input id="fNetAmount" class="form-control fw-bold mb-2" placeholder="‡§∂‡•Å‡§¶‡•ç‡§ß ‡§∞‡§æ‡§∂‡§ø" readonly>

    <textarea id="fNote" class="form-control mb-3" placeholder="‡§®‡•ã‡§ü"></textarea>

    <button class="btn btn-success w-100 mb-2" onclick="saveFasal()">‚úî ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
    <button class="btn btn-danger w-100" onclick="closeFasalPopup()">‡§∞‡§¶‡•ç‡§¶</button>

  </div>
</div>


<script>
window.onload = () => {
    if(localStorage.getItem("logged") === "yes"){
        loginScreen.style.display = "none";
        customerListCard.style.display = "block";
        loadCustomers();
    }
};

/* ======================================================
   Firebase Init
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyB30K96un0DsFbJ0-dx329za1HEnky3iC8",
  authDomain: "ms-saini.firebaseapp.com",
  databaseURL: "https://ms-saini-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ms-saini",
  storageBucket: "ms-saini.appspot.com",
  messagingSenderId: "56761297643",
  appId: "1:56761297643:web:efbb8d890036191cfcacae"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentCustomerId = null;

/* ======================================================
      CARD SWITCHING
====================================================== */
function showCard(id){
  customerListCard.style.display="none";
  addCustomerCard.style.display="none";
  ledgerCard.style.display="none";
  loginScreen.style.display="none";

  document.getElementById(id).style.display="block";
}

function backToList(){
    showCard("customerListCard");
    loadCustomers(() => {
        filterCustomers();   // üî• search + village filter ‡§µ‡§æ‡§™‡§∏ apply
    });
}

/* ======================================================
      LOAD CUSTOMERS
====================================================== */
function loadCustomers(callback){
  const ref = db.ref("customers");

  ref.once("value").then(snap=>{
      customerTable.innerHTML = "";

      snap.forEach(c=>{
        let d = c.val();
        let id = c.key;

        
        let row = `
        <tr>
          <td class="check-col"><input value="${id}" class="customerCheckbox" type="checkbox"></td>

          <td class="name-col">
            <span style="color:blue;cursor:pointer" onclick="openLedger('${id}')">
              ${(d.name || "").replace(/\s+\d+$/, "").replace(" ", "<br>")}
            </span>
          </td>

          <td class="reg-col">${d.rn || ((d.name || "").match(/\d+$/) || [""])[0]}</td>
      <td>${d.father || ""}</td>
          <td>${d.village || ""}</td>
          <td>${d.phone || ""}</td>
          <td>${d.aadhar || ""}</td>

          <td>
            <button class="btn btn-sm btn-primary" onclick="editCustomer('${id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${id}')">üóë</button>
          </td>
        </tr>
        `;
        customerTable.insertAdjacentHTML("beforeend", row);
      });

      document.getElementById("customerCount").innerText = snap.numChildren();
if(callback) callback();
  });
}

/* ======================================================
      OPEN LEDGER
====================================================== */
function openLedger(id){
  currentCustomerId = id;

  db.ref("customers/" + id).once("value").then(s=>{
    ledgerCustomerName.innerText = s.val().name;
  });

  showCard("ledgerCard");
  loadLedger();
}

/* ======================================================
      LOAD LEDGER + FASAL SUMMARY
====================================================== */
function loadLedger(){
  const ref = db.ref("ledgers/" + currentCustomerId);

  ref.once("value").then(snap=>{
      ledgerTable.innerHTML = "";

      let totalC = 0, totalD = 0, totalI = 0;
      let allFasal = [];

      snap.forEach(e=>{
        let d = e.val();
        let key = e.key;

        totalC += +d.credit || 0;
        totalD += +d.debit || 0;
        if(d.interestType === "debit"){
    totalI += +d.interestAmount || 0;   // Debit interest add
}else{
    totalI -= +d.interestAmount || 0;   // Credit interest minus
}

        if(d.isFasal) allFasal.push(d);

        let row = `
<tr style="${d.isFasal ?
'background:#fff7d1;color:#b8860b;font-weight:bold;' : ''}">

    <td>${d.startDate || d.date || ""}</td>
    <td>${d.endDate || ""}</td>

    <td>‚Çπ${d.credit || 0}</td>
    <td>‚Çπ${d.debit || 0}</td>
    <td>${d.interest || 0}</td>
    <td>${d.days || 0}</td>
  <td>${d.isFasal ? "" : "+‚Çπ" + (d.interestAmount || 0)}</td>
<td>
${d.isFasal
  ? (function(){
      let q = +d.quintal || 0;
      let totalKG = q * 100;

      let mainQ = Math.floor(totalKG / 100);
      let extraKG = Math.round(totalKG % 100);

      let name = d.name || "";
let firstChar = name.trim().charAt(0);

// ‡§Ö‡§ó‡§∞ ‡§®‡§æ‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á emoji ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à
if (/\p{Emoji}/u.test(firstChar)) {
    return name + " (" + mainQ + " Q " + extraKG + " KG)";
} else {
    let name = d.name || "";

let hasIcon = name.trim().startsWith("üå±") ||
              name.trim().startsWith("üåæ") ||
              name.trim().startsWith("üåª") ||
              name.trim().startsWith("üåΩ") ||
              name.trim().startsWith("ü•ú") ||
              name.trim().startsWith("üåø");

let finalName = hasIcon ? name : "üåæ " + name;

return finalName + " (" + mainQ + " Q " + extraKG + " KG)";
}
    })()
  : ""
}
</td>
    <td>${d.note || ""}</td>

    <td>
        ${
          d.isFasal
          ? `<button class="btn btn-sm btn-primary" onclick="editFasal('${key}')">‚úèÔ∏è</button>`
          : `<button class="btn btn-sm btn-primary" onclick="editTransaction('${key}')">‚úèÔ∏è</button>`
        }
        <button class="btn btn-sm btn-danger" onclick="deleteLedgerEntry('${key}')">‚ùå</button>
    </td>
</tr>
`; 
ledgerTable.insertAdjacentHTML("beforeend", row);
      });

      // ‚≠ê ‡§´‡§∏‡§≤ TOTAL ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
let totalFasalNet = 0;
let totalFasalMajduri = 0;
let totalFasalCut = 0;

allFasal.forEach(f => {
    totalFasalNet += +f.netFasal || 0;
    totalFasalMajduri += +f.totalMajduri || 0;
    totalFasalCut += +f.totalCut || 0;
});

// ‚≠ê Final Balance Calculation (‡§´‡§∏‡§≤ + ‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä + ‡§ï‡§ü‡•å‡§§‡•Ä ‡§∂‡§æ‡§Æ‡§ø‡§≤)
let balance =
    (totalD + totalI) -
    (totalC + totalFasalNet + totalFasalMajduri + totalFasalCut);

// ‚≠ê FOOTER ‡§¶‡§ø‡§ñ‡§æ‡§ì
ledgerFooter.innerHTML = `
<tr class="total-row" style="background:#fff3cd;font-weight:bold;color:#a66d00;">
    <td colspan="2">‡§ï‡•Å‡§≤</td>
    <td>‚Çπ${totalC}</td>
    <td>‚Çπ${totalD}</td>
    <td></td>
    <td>‚Çπ${totalI.toFixed(2)}</td>
    <td colspan="3">
        ‡§∂‡•á‡§∑: ‚Çπ${balance.toFixed(2)}<br>
        <small>(‡§®‡•á‡§ü ‡§´‡§∏‡§≤: ‚Çπ${totalFasalNet} | ‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä: ‚Çπ${totalFasalMajduri} | ‡§ï‡§ü‡•å‡§§‡•Ä: ‚Çπ${totalFasalCut})</small>
    </td>
</tr>
`;
// =============== ‡§ï‡•Å‡§≤ ‡§´‡§∏‡§≤ ‡§ü‡•ã‡§ü‡§≤ ===============
let fasalTQ = 0, fasalTAmount = 0, fasalTNet = 0;

allFasal.forEach(f => {
  fasalTQ += +f.quintal || 0;
  fasalTAmount += +f.totalAmount || 0;
  fasalTNet += +f.netFasal || 0;
});

ledgerFooter.insertAdjacentHTML("beforeend", `
  <tr style="background:#fff3cd;font-weight:bold;color:#a66d00;">
    <td colspan="2">‡§ï‡•Å‡§≤ ‡§´‡§∏‡§≤</td>
    <td colspan="2">‡§ï‡•Å‡§≤ ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤: ${fasalTQ.toFixed(2)}</td>
    <td colspan="2">‡§ï‡•Å‡§≤ ‡§ï‡•Ä‡§Æ‡§§: ‚Çπ${fasalTAmount}</td>
    <td colspan="3">‡§®‡•á‡§ü ‡§´‡§∏‡§≤: ‚Çπ${fasalTNet}</td>
  </tr>
`);

      generateFasalSummary(allFasal);
  });
}

/* ======================================================
      COLLAPSE FASAL SUMMARY
====================================================== */
function toggleFasalSummary(){
  const b = fasalSummary;
  b.style.display = b.style.display == "block" ? "none" : "block";
}

function generateFasalSummary(all){
    if(all.length == 0){
        fasalSummary.innerHTML = "<div class='p-2 text-center'>‡§ï‡•ã‡§à ‡§´‡§∏‡§≤ ‡§®‡§π‡•Ä‡§Ç</div>";
        return;
    }

    fasalSummary.innerHTML = ""; // ‡§™‡§π‡§≤‡•á ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•ã

    all.forEach((f, i) => {
        fasalSummary.insertAdjacentHTML("beforeend", `
            <div class="fasal-box" style="margin:8px 0;padding:8px;border-radius:8px;background:#fff5d6;border:1px solid #e6c77e">
                <div onclick="openFasal(${i})" style="font-weight:bold;font-size:16px;cursor:pointer;">
                    ‚ñ∂ ‡§´‡§∏‡§≤ ${i+1} (Tap to open)
                </div>

                <div id="fasalDetail${i}" style="display:none;margin-top:6px;line-height:22px;">
                    üåæ ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤: <b>${f.quintal}</b><br>
                    üí∞ ‡§ï‡•Ä‡§Æ‡§§: <b>‚Çπ${f.totalAmount}</b><br>
                    üß≥ ‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä: <b>‚Çπ${f.totalMaiduri}</b><br>
                    ‚úÇ ‡§ï‡§ü‡•å‡§§‡•Ä: <b>‚Çπ${f.totalCut}</b><br>
                    üü° ‡§®‡•á‡§ü ‡§´‡§∏‡§≤: <b>‚Çπ${f.netFasal}</b>
                </div>
            </div>
        `);
    });
}

function openFasal(i){
    const a = document.getElementById("fasalDetail"+i);
    a.style.display = a.style.display === "block" ? "none" : "block";
}

  

/* ======================================================
      SAVE NORMAL TRANSACTION
====================================================== */
function openTransactionPopup(){

    // ‡§∏‡§≠‡•Ä fields clear ‡§ï‡§∞‡•ã
    tDate.value = "";
    tEndDate.value = "";
    tCredit.value = "";
    tDebit.value = "";
    tInterest.value = "";
    tDays.value = "";
    tInterestAmount.value = "";
    tNote.value = "";

    transactionPopupOverlay.style.display = "flex";
}
function closeTransactionPopup(){
  transactionPopupOverlay.style.display="none";
}

function saveTransaction(){

    let start = tDate.value || "";     // Start date ‡§ñ‡§æ‡§≤‡•Ä allowed
    let end = tEndDate.value || "";    // End date ‡§ñ‡§æ‡§≤‡•Ä allowed

    let days = 0;
    let totalInterest = 0;

    // ‡§Ø‡§¶‡§ø user ‡§®‡•á end date ‡§¶‡•Ä ‡§π‡•à ‡§§‡§≠‡•Ä ‡§¶‡§ø‡§®/‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§®‡§ø‡§ï‡§æ‡§≤‡•ã
    if(start && end){
        let d1 = new Date(start);
        let d2 = new Date(end);

        days = Math.floor((d2 - d1) / (1000*60*60*24));

        if(days < 0){
            alert("End Date, Start Date ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è!");
            return;
        }

        let amount = +tDebit.value || +tCredit.value || 0;
        let rate = +tInterest.value || 0;

        let monthlyInterest = (amount * rate) / 100;
        let dailyInterest = monthlyInterest / 30;
        totalInterest = dailyInterest * days;
    }

    let data = {
    startDate: start,
    endDate: end,
    credit: +tCredit.value || 0,
    debit: +tDebit.value || 0,
    interest: +tInterest.value || 0,
    days: days,
    interestAmount: +tInterestAmount.value || 0,
    interestType: (+tDebit.value || 0) > 0 ? "debit" : "credit",
    note: tNote.value
};
    // ‚≠ê EDIT MODE
    if(window.editingTransactionId){
        db.ref("ledgers/" + currentCustomerId + "/" + window.editingTransactionId).update(data);
        window.editingTransactionId = null;
    }
    // ‚≠ê NEW ENTRY
    else{
        db.ref("ledgers/" + currentCustomerId).push(data);
    }

    closeTransactionPopup();
    loadLedger();
}
/* ======================================================
      FASAL AUTO CALC
====================================================== */
["fBori","fWeightPer","fExtraKG","fRate","fMajduri","fCutOther"].forEach(id=>{ document.getElementById(id).addEventListener("input", calcFasal);
});

function calcFasal(){
  let b = +fBori.value||0;
  let w = +fWeightPer.value||0;
  let r = +fRate.value||0;
  let m = +fMajduri.value||0;
  let o = +fCutOther.value||0;

let extra = +fExtraKG.value || 0;
let totalKG = (b * w) + extra;
  let q = totalKG / 100;
  fTotalQ.value = q.toFixed(2);

  let totalAmount = q * r;
  let totalMajduri = q * m;
  let totalCut = totalMajduri + o;
  let net = totalAmount - totalCut;

  fCutTotal.value = totalCut;
  fNetAmount.value = net;
}
function openFasalPopup() {
    fasalPopupOverlay.style.display = "flex";

    // üî• ‡§π‡§∞ ‡§¨‡§æ‡§∞ dropdown refresh
    loadFasalDropdown();

    // üî• ‡§∏‡§≠‡•Ä fields ‡§∏‡§æ‡§´ (new entry)
    fName.value = "";
    fBori.value = "";
    fWeightPer.value = "";
    fTotalQ.value = "";
    fRate.value = "";
    fMajduri.value = "";
    fCutOther.value = "";
    fCutTotal.value = "";
    fNetAmount.value = "";
    fNote.value = "";

    // üî• Editing mode ‡§¨‡§Ç‡§¶
    window.editingFasalId = null;
}
/* ======================================================
      SAVE FASAL ENTRY
====================================================== */
function saveFasal(){

  if(!fName.value) return alert("‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç!");

  let b = +fBori.value||0;
  let w = +fWeightPer.value||0;
  let q = +fTotalQ.value||0;
  let r = +fRate.value||0;
  let m = +fMajduri.value||0;
  let o = +fCutOther.value||0;

  let totalAmount = q * r;
  let totalMajduri = q * m;
  let totalCut = totalMajduri + o;
  let net = totalAmount - totalCut;

  let data = {
    isFasal:true,
    name:fName.value,
date: fDate.value || "",
    bori:b,
    weightPer:w,
    quintal:q,
    rate:r,
    totalAmount,
    totalMajduri,
    totalCut,
    netFasal:net,
    note:fNote.value
  };

  // üî• EDIT MODE
  if(window.editingFasalId){
      db.ref("ledgers/" + currentCustomerId + "/" + window.editingFasalId).update(data);
      window.editingFasalId = null;
  } 

  // üî• NEW ENTRY MODE
  else {
      db.ref("ledgers/" + currentCustomerId).push(data);
  }

  closeFasalPopup();
  loadLedger();
}

/* ======================================================
      DELETE LEDGER ENTRY
====================================================== */
function deleteLedgerEntry(id){
  if(!confirm("‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
  db.ref("ledgers/" + currentCustomerId + "/" + id).remove();
  loadLedger();
}

/* ======================================================
      PRINT
====================================================== */
function printLedger(){
    // ‡§´‡§∏‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§¶‡§ø‡§ñ‡§æ‡§ì ‡§§‡§æ‡§ï‡§ø PDF ‡§Æ‡•á‡§Ç ‡§Ü‡§è
    fasalSummary.style.display = "block";

    // PDF ‡§∏‡•á‡§µ ‡§ï‡§∞‡•ã
    window.print();
}
/* ======================================================
      SEARCH + FILTER SYSTEM
====================================================== */
document.getElementById("searchBox").addEventListener("input", () => filterCustomers());
document.getElementById("villageFilter").addEventListener("change", () => filterCustomers());

function filterCustomers() {
    let search = searchBox.value.toLowerCase();
    let village = villageFilter.value;

    [...customerTable.rows].forEach(r => {
        let name = r.cells[1].innerText.toLowerCase();
        let vill = r.cells[4].innerText;

        let ok =
            (search === "" || name.includes(search)) &&
            (village === "" || village === vill);

        r.style.display = ok ? "" : "none";
    });
}

/* ======================================================
      ADD CUSTOMER
====================================================== */
function openAddCustomer() {
    showCard("addCustomerCard");
}

function saveCustomer() {

    if (!cName.value) return alert("‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç!");

    let obj = {
    name: cName.value,
    father: cFather.value,
    village: cVillage.value,
    phone: cPhone.value,
    aadhar: cAadhar.value,
    rn: cRN.value          // ‚≠ê ‡§®‡§Ø‡§æ ‡§ú‡•ã‡§°‡§º‡§æ
};

    db.ref("customers").push(obj);

    cName.value = "";
    cFather.value = "";
    cVillage.value = "";
    cPhone.value = "";
    cAadhar.value = "";

    backToList();
}

/* ======================================================
      EDIT CUSTOMER
====================================================== */
let editingCustomerId = null;

function editCustomer(id) {
    editingCustomerId = id;

    db.ref("customers/" + id).once("value").then(s => {
        let d = s.val();

        cName.value = d.name;
        cFather.value = d.father;
        cVillage.value = d.village;
        cPhone.value = d.phone;
        cAadhar.value = d.aadhar;
cRN.value = d.rn || "";
        showCard("addCustomerCard");
    });
}

/* save edited customer */
function saveEditedCustomer() {
    if (!editingCustomerId) return saveCustomer();

    let obj = {
        name: cName.value,
        father: cFather.value,
        village: cVillage.value,
        phone: cPhone.value,
        aadhar: cAadhar.value,
        rn: cRN.value        // ‚≠ê ‡§Ø‡§π ‡§≤‡§æ‡§á‡§® ‡§ú‡§º‡§∞‡•Ç‡§∞ ‡§°‡§æ‡§≤‡§®‡•Ä ‡§π‡•à
    };

    db.ref("customers/" + editingCustomerId).update(obj);

    editingCustomerId = null;
    backToList();
}

/* ======================================================
      DELETE CUSTOMER
====================================================== */
function deleteCustomer(id) {
    if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§®‡§æ ‡§π‡•à?")) return;

    db.ref("customers/" + id).remove();
    db.ref("ledgers/" + id).remove();

    loadCustomers();
}

/* ======================================================
      SELECT ALL CHECKBOX
====================================================== */
function toggleSelectAll(source) {
    document.querySelectorAll(".customerCheckbox").forEach(c => (c.checked = source.checked));
}

/* ======================================================
      DELETE SELECTED CUSTOMERS
====================================================== */
function deleteSelectedCustomers() {
    let selected = [...document.querySelectorAll(".customerCheckbox:checked")].map(c => c.value);

    if (selected.length === 0) return alert("‡§ï‡§ø‡§∏‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§ö‡•Å‡§®‡§æ ‡§®‡§π‡•Ä‡§Ç!");

    if (!confirm("‡§ö‡•Å‡§®‡•á ‡§π‡•Å‡§è ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡§ü‡§æ‡§ä‡§Å?")) return;

    selected.forEach(id => {
        db.ref("customers/" + id).remove();
        db.ref("ledgers/" + id).remove();
    });

    loadCustomers();
}

/* ======================================================
      DELETE ALL CUSTOMERS
====================================================== */
function deleteAllCustomers() {
    if (!confirm("‚ùå ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§π‡•à?")) return;

    db.ref("customers").remove();
    db.ref("ledgers").remove();

    loadCustomers();
}

/* ======================================================
      PRINT CUSTOMER LIST
====================================================== */
function printCustomers() {
    window.print();
}

/* ======================================================
      EXCEL UPLOAD
====================================================== */
excelUpload.addEventListener("change", handleExcelUpload);

function handleExcelUpload(e) {
    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function () {
        let data = new Uint8Array(reader.result);
        let workbook = XLSX.read(data, { type: "array" });

        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet);

        json.forEach(row => {
            let c = {
                name: row.name || "",
                father: row.father || "",
                village: row.village || "",
                phone: row.phone || "",
                aadhar: row.aadhar || ""
            };
            db.ref("customers").push(c);
        });

        alert("Excel Import Done ‚úî");
        loadCustomers();
    };
    reader.readAsArrayBuffer(file);
}

/* ======================================================
      SUMMARY ON LIST PAGE
====================================================== */
function toggleSummary() {
    let box = totalSummary;
    if (box.style.display == "block") {
        box.style.display = "none";
        return;
    }

    db.ref("ledgers").once("value").then(snap => {
        let sumC = 0,
            sumD = 0,
            sumI = 0;

        snap.forEach(c => {
            c.forEach(r => {
                let d = r.val();
                sumC += +d.credit || 0;
                sumD += +d.debit || 0;
                sumI += +d.interestAmount || 0;
            });
        });

        let bal = (sumD + sumI) - sumC;

        box.innerHTML = `
          ‡§ú‡§Æ‡§æ: ‚Çπ${sumC}<br>
          ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä: ‚Çπ${sumD}<br>
          ‡§¨‡•ç‡§Ø‡§æ‡§ú: ‚Çπ${sumI.toFixed(2)}<br>
          ‡§∂‡•á‡§∑: ‚Çπ${bal.toFixed(2)}
        `;
        box.style.display = "block";
    });
}

/* ======================================================
      VILLAGE MANAGER (FINAL WORKING)
====================================================== */

// Popup ‡§ñ‡•ã‡§≤‡§®‡§æ
customerListCard.style.display = "none";
function openVillageManager() {
    let html = `
      <div id="villagePopupBox" style="background:white;padding:20px;border-radius:12px;width:90%;max-width:400px;">
         <h5 class="text-center mb-3">üè° ‡§ó‡§æ‡§Å‡§µ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h5>

         <input id="newVillage" class="form-control mb-2" placeholder="‡§®‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç">

         <button class="btn btn-success w-100 mb-3" onclick="addVillage()">‚úî ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>

         <div id="villageList" style="max-height:300px;overflow-y:auto;"></div>

         <button onclick="closeVillagePopup()" class="btn btn-danger w-100 mt-3">‚ùå ‡§¨‡§Ç‡§¶</button>
      </div>
    `;

    villagePopup.innerHTML = html;
    villagePopup.style.display = "flex";

    loadVillageList();
}

// Popup ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡§æ
customerListCard.style.display = "block";
function closeVillagePopup() {
    villagePopup.style.display = "none";
}

/* ‚≠ê ‡§®‡§Ø‡§æ ‡§ó‡§æ‡§Å‡§µ add ‡§ï‡§∞‡§®‡§æ */
function addVillage() {
    let v = document.getElementById("newVillage").value.trim();
    if (!v) return alert("‡§ó‡§æ‡§Å‡§µ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç!");

    // ‚úî ‡§∏‡§π‡•Ä ‡§ú‡§ó‡§π ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ
    db.ref("settings/villages").push(v);

    document.getElementById("newVillage").value = "";
    loadVillageList();
    loadVillageDropdown();
loadFasalDropdown();
}

/* ‚≠ê Village list ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ (Popup ‡§Æ‡•á‡§Ç) */
function loadVillageList() {
    const box = document.getElementById("villageList");
    box.innerHTML = "";

    db.ref("settings/villages").once("value").then(snap => {
        snap.forEach(v => {
            let name = v.val();
            let id = v.key;

            box.insertAdjacentHTML("beforeend", `
                <div class="d-flex justify-content-between p-2 border mb-1">
                    ${name}
                    <button class="btn btn-sm btn-danger" onclick="deleteVillage('${id}')">‚ùå</button>
                </div>
            `);
        });
    });
}

/* ‚≠ê Village delete ‡§ï‡§∞‡§®‡§æ */
function deleteVillage(id) {
    db.ref("settings/villages/" + id).remove();
    loadVillageList();
    loadVillageDropdown();
}

/* ‚≠ê Dropdown ‡§Æ‡•á‡§Ç village ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ */
function loadVillageDropdown() {

    cVillage.innerHTML = `<option value="">‡§ó‡§æ‡§Å‡§µ ‡§ö‡•Å‡§®‡•á‡§Ç</option>`;
    villageFilter.innerHTML = `<option value="">‡§∏‡§≠‡•Ä ‡§ó‡§æ‡§Å‡§µ</option>`;

    db.ref("settings/villages").once("value").then(snap => {
        snap.forEach(v => {
            let name = v.val();

            cVillage.insertAdjacentHTML("beforeend", `<option>${name}</option>`);
            villageFilter.insertAdjacentHTML("beforeend", `<option>${name}</option>`);
        });
    });
}

loadVillageDropdown();
/* ======================================================
      LOGIN SYSTEM
====================================================== */

const MASTER_PASS = "1234";          // ‡§Ö‡§™‡§®‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á‡§ü ‡§ï‡§∞‡•ã
const FAV_NAME = "saini";            // Forgot password ‡§µ‡§æ‡§≤‡§æ ‡§®‡§æ‡§Æ

function loginNow(){
    let p = loginPass.value.trim();
    if(p === MASTER_PASS){
localStorage.setItem("logged", "yes");
        loginScreen.style.display = "none";
        customerListCard.style.display = "block";
        loadCustomers();
    } else {
        alert("‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!");
    }
}

function showForgot(){
    loginScreen.style.display = "none";
    forgotBox.style.display = "block";
}

function hideForgot(){
    forgotBox.style.display = "none";
    loginScreen.style.display = "block";
}

function resetPass(){
    let name = favName.value.trim().toLowerCase();
    if(name === FAV_NAME){
        alert("‚úî ‡§Ü‡§™‡§ï‡§æ ‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§π‡•à: " + MASTER_PASS);
        hideForgot();
    } else {
        alert("‚ùå ‡§ó‡§≤‡§§ ‡§®‡§æ‡§Æ!");
    }
}

function logoutNow(){
localStorage.removeItem("logged");
    customerListCard.style.display = "none";
    ledgerCard.style.display = "none";
    addCustomerCard.style.display = "none";
    loginScreen.style.display = "block";
}

/* Dummy Fingerprint ‚Äî Mobile ‡§™‡§∞ ‡§ï‡§æ‡§Æ ‡§§‡§≠‡•Ä ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ú‡§¨ browser allow ‡§ï‡§∞‡•á */
function registerFinger(){
    alert("Fingerprint Registered ‚úî");
}

function fingerLogin(){
    alert("Fingerprint Success ‚úî");
    loginNow();
}
function editFasal(id){
    db.ref("ledgers/" + currentCustomerId + "/" + id).once("value").then(s=>{
        let f = s.val();

        if(!f.isFasal){
            alert("‡§Ø‡§π ‡§´‡§∏‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        fasalPopupOverlay.style.display = "flex";

        fName.value = f.name;
        fBori.value = f.bori;
        fWeightPer.value = f.weightPer;
        fTotalQ.value = f.quintal;
        fRate.value = f.rate;

        let perMajduri = f.totalMajduri / f.quintal;
        fMajduri.value = perMajduri;

        fCutOther.value = f.totalCut - f.totalMajduri;

        fCutTotal.value = f.totalCut;
        fNetAmount.value = f.netFasal;
        fNote.value = f.note;

        window.editingFasalId = id;
    });
}
tDate.onchange = calcDays;
tEndDate.onchange = calcDays;
tInterest.oninput = calcInterest;
tDebit.oninput = calcInterest;
tCredit.oninput = calcInterest;   // ‚≠ê‚≠ê‚≠ê ‡§Ø‡§π‡•Ä missing ‡§•‡§æ
tDays.oninput = calcInterest;
function calcDays() {
    let start = tDate.value;
    let end = tEndDate.value;

    if (!start || !end) {
        tDays.value = "";
        tInterestAmount.value = "";
        return;
    }

    let d1 = new Date(start);
    let d2 = new Date(end);

    let diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));

    if (diff < 0) {
        alert("End Date, Start Date ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è!");
        tEndDate.value = "";
        tDays.value = "";
        return;
    }

    tDays.value = diff;
    calcInterest();  // ‡§¶‡§ø‡§® ‡§¨‡§¶‡§≤‡§§‡•á ‡§π‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§≠‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü
}

function calcInterest() {
    let amount = (+tDebit.value > 0)
    ? +tDebit.value
    : +tCredit.value;   // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§∞‡§æ‡§∂‡§ø
    let rate = +tInterest.value || 0;    // ‡§¨‡•ç‡§Ø‡§æ‡§ú %
    let days = +tDays.value || 0;        // ‡§¶‡§ø‡§®

    if(amount === 0 || rate === 0 || days === 0){
        tInterestAmount.value = "";
        return;
    }

    // Monthly interest = (amount * rate) / 100
    let monthlyInterest = (amount * rate) / 100;

    // Daily interest = monthlyInterest / 30
    let dailyInterest = monthlyInterest / 30;

    // Total interest = dailyInterest * days
    let totalInterest = dailyInterest * days;

    tInterestAmount.value = totalInterest.toFixed(2);
}
function editTransaction(id){
    window.editingTransactionId = id;

    db.ref("ledgers/" + currentCustomerId + "/" + id).once("value").then(s=>{
        let d = s.val();

        // Normal transaction ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, fasal ‡§®‡§π‡•Ä‡§Ç
        if(d.isFasal){
            alert("‡§Ø‡§π ‡§´‡§∏‡§≤ ‡§π‡•à, ‡§á‡§∏‡•á ‡§´‡§∏‡§≤ Edit ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç!");
            return;
        }

        // Popup ‡§ñ‡•ã‡§≤‡•ã
        transactionPopupOverlay.style.display = "flex";

        // ‡§™‡•Å‡§∞‡§æ‡§®‡•á values ‡§≠‡§∞ ‡§¶‡•ã
        tDate.value = d.startDate || "";
        tEndDate.value = d.endDate || "";
        tCredit.value = d.credit || 0;
        tDebit.value = d.debit || 0;
        tInterest.value = d.interest || 0;
        tDays.value = d.days || 0;
        tInterestAmount.value = d.interestAmount || 0;
        tNote.value = d.note || "";
    });
}
/* ======================================================
      FASAL MANAGER (ADD / DELETE)
====================================================== */

function openFasalManager() {
    document.getElementById("fasalManagerPopup").style.display = "flex";
    loadFasalList();
}

function closeFasalManager() {
    document.getElementById("fasalManagerPopup").style.display = "none";
}

function addNewFasal() {
    let name = document.getElementById("newFasalName").value.trim();

    if (!name) return alert("‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç!");

    db.ref("fasals").push({ name });
    document.getElementById("newFasalName").value = "";
    loadFasalList();
    loadFasalDropdown();   // dropdown refresh
}

function deleteFasal(id) {
    if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§´‡§∏‡§≤ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

    db.ref("fasals/" + id).remove();
    loadFasalList();
    loadFasalDropdown();
}

function loadFasalList() {
    const box = document.getElementById("fasalList");
    box.innerHTML = "";

    db.ref("fasals").once("value").then(snap => {
        snap.forEach(f => {
            let d = f.val();
            let id = f.key;

            box.insertAdjacentHTML("beforeend", `
                <div class="d-flex justify-content-between p-2 border mb-1">
                    ${d.name}
                    <button class="btn btn-sm btn-danger" onclick="deleteFasal('${id}')">‚ùå</button>
                </div>
            `);
        });
    });
}

function loadFasalDropdown() {
    db.ref("fasals").once("value").then(snap => {
        fName.innerHTML = `<option value="">‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</option>`;

        snap.forEach(f => {
            let d = f.val();
            fName.insertAdjacentHTML("beforeend", `<option>${d.name}</option>`);
        });
    });
}
loadFasalDropdown();
function closeFasalPopup() {
    document.getElementById("fasalPopupOverlay").style.display = "none";
    window.editingFasalId = null;   // edit ‡§Æ‡•ã‡§° ‡§¨‡§Ç‡§¶
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

</body>
</html>